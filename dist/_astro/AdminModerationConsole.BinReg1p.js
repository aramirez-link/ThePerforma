import{j as e}from"./jsx-runtime.TBa3i5EZ.js";import{r as o}from"./index.CVf8TyFT.js";import{x as z,y as R,z as K,A as Q,B as V}from"./fanVault.BDzHPXqn.js";import{g as p,s as I,a as Y,i as G}from"./storefront.DD1YA6uZ.js";import"./index.BtUICepX.js";const H=[{label:"Approve",value:"approved"},{label:"Flag",value:"flagged"},{label:"Reject",value:"rejected"}],J=[{label:"Reviewed",value:"reviewed"},{label:"Resolved",value:"resolved"},{label:"Dismiss",value:"dismissed"}],x="the-performa-admin-nav",X=c=>{try{return new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short"}).format(new Date(c))}catch{return c}};function re(){const[c,f]=o.useState(!0),[w,y]=o.useState(!1),[i,n]=o.useState(""),[j,A]=o.useState(""),[h,T]=o.useState(""),[M,C]=o.useState(!1),[v,E]=o.useState([]),[F,U]=o.useState({}),[m,O]=o.useState("open"),[b,N]=o.useState(!1),[S,k]=o.useState(!1),u=async()=>{const[t,s]=await Promise.all([Q(200),V()]);if(!t.ok){n(t.error);return}s.ok&&N(s.enabled),E(t.reports);const r=Array.from(new Set(t.reports.filter(a=>a.targetType==="post").map(a=>Number(a.targetId)))),d=Array.from(new Set(t.reports.filter(a=>a.targetType==="comment").map(a=>Number(a.targetId)))),l=p();if(!l)return;const[{data:W},{data:q}]=await Promise.all([r.length?l.from("fan_feed_posts").select("id,user_id,body,media_url,moderation_status,moderation_reason,created_at").in("id",r):Promise.resolve({data:[]}),d.length?l.from("fan_feed_comments").select("id,user_id,body,moderation_status,moderation_reason,created_at").in("id",d):Promise.resolve({data:[]})]),g={};(W||[]).forEach(a=>{g[`post:${a.id}`]={id:String(a.id),type:"post",authorId:a.user_id,body:a.body||"",mediaUrl:a.media_url||null,moderationStatus:a.moderation_status||"approved",moderationReason:a.moderation_reason||null,createdAt:a.created_at}}),(q||[]).forEach(a=>{g[`comment:${a.id}`]={id:String(a.id),type:"comment",authorId:a.user_id,body:a.body||"",mediaUrl:null,moderationStatus:a.moderation_status||"approved",moderationReason:a.moderation_reason||null,createdAt:a.created_at}}),U(g)};o.useEffect(()=>{const t=async()=>{f(!0);const d=await Y();T(d?.email||"");const l=await G();C(l),typeof window<"u"&&(l?localStorage.setItem(x,"true"):localStorage.removeItem(x)),l&&await u(),f(!1)};t();const r=p()?.auth.onAuthStateChange(()=>{t()});return()=>r?.data.subscription.unsubscribe()},[]),o.useEffect(()=>{if(!i)return;const t=window.setTimeout(()=>n(""),2800);return()=>window.clearTimeout(t)},[i]);const _=o.useMemo(()=>v.filter(t=>m==="all"||t.status===m),[v,m]),$=async()=>{const t=p();if(!t){n("Supabase is not configured.");return}y(!0);const{error:s}=await t.auth.signInWithOtp({email:j.trim().toLowerCase(),options:{emailRedirectTo:typeof window<"u"?`${window.location.origin}/admin/moderation`:void 0}});y(!1),n(s?s.message:"Check your email for the magic link.")},L=async t=>{const s=p();if(!s){n("Supabase is not configured.");return}const{error:r}=await s.auth.signInWithOAuth({provider:t,options:{redirectTo:typeof window<"u"?`${window.location.origin}/admin/moderation`:void 0}});r&&n(r.message)},B=async(t,s)=>{const r=window.prompt("Moderation reason (optional):","")||"",d=await z({targetType:t.targetType,targetId:t.targetId,status:s,reason:r||null});if(!d.ok){n(d.error);return}await R({reportId:t.id,status:"reviewed"}),n(`Content marked ${s}.`),await u()},D=async(t,s)=>{const r=await R({reportId:t,status:s});if(!r.ok){n(r.error);return}n(`Report moved to ${s}.`),await u()},P=async()=>{k(!0);const s=await K(!b);if(k(!1),!s.ok){n(s.error);return}N(s.enabled),n(s.enabled?"Feed moderation enabled.":"Feed moderation disabled."),await u()};return c?e.jsx("section",{className:"mx-auto w-full max-w-6xl px-4 pb-20 pt-8 sm:px-6",children:e.jsx("div",{className:"rounded-3xl border border-white/15 bg-black/45 p-6",children:e.jsx("p",{className:"text-sm text-white/70",children:"Loading moderation console..."})})}):h?M?e.jsxs("section",{className:"mx-auto w-full max-w-6xl px-4 pb-20 pt-8 sm:px-6",children:[e.jsx("div",{className:"rounded-3xl border border-white/15 bg-black/45 p-6",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-gold/80",children:"Admin Moderation"}),e.jsx("h1",{className:"mt-2 font-display text-3xl",children:"Safety Queue"}),e.jsx("p",{className:"mt-1 text-sm text-white/70",children:h}),e.jsxs("p",{className:"mt-1 text-xs text-white/60",children:["Moderation: ",b?"ON (new posts/comments may be queued)":"OFF (new posts/comments auto-approved)"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:P,disabled:S,className:"min-h-11 rounded-full border border-gold/45 px-4 py-2 text-[11px] uppercase tracking-[0.22em] text-gold disabled:opacity-50",children:S?"Updating...":b?"Turn Moderation Off":"Turn Moderation On"}),e.jsxs("select",{value:m,onChange:t=>O(t.target.value),className:"min-h-11 rounded-full border border-white/30 bg-black/35 px-4 py-2 text-[11px] uppercase tracking-[0.22em] text-white/80",children:[e.jsx("option",{value:"all",children:"all"}),e.jsx("option",{value:"open",children:"open"}),e.jsx("option",{value:"reviewed",children:"reviewed"}),e.jsx("option",{value:"resolved",children:"resolved"}),e.jsx("option",{value:"dismissed",children:"dismissed"})]}),e.jsx("button",{type:"button",onClick:async()=>{localStorage.removeItem(x),await I(),window.location.reload()},className:"min-h-11 rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.24em] text-white/80",children:"Sign out"})]})]})}),e.jsxs("div",{className:"mt-5 space-y-3",children:[_.map(t=>{const s=F[`${t.targetType}:${t.targetId}`];return e.jsxs("article",{className:"rounded-3xl border border-white/15 bg-black/35 p-5",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs uppercase tracking-[0.24em] text-gold/80",children:["Report #",t.id," • ",t.targetType]}),e.jsxs("p",{className:"mt-1 text-xs text-white/55",children:["Reason: ",t.reasonCode," • Status: ",t.status," • ",X(t.createdAt)]}),t.details&&e.jsxs("p",{className:"mt-1 text-xs text-white/65",children:["Notes: ",t.details]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:J.map(r=>e.jsx("button",{type:"button",onClick:()=>D(t.id,r.value),className:"min-h-10 rounded-full border border-white/25 px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-white/75",children:r.label},r.value))})]}),e.jsx("div",{className:"mt-3 rounded-2xl border border-white/12 bg-black/25 p-3",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-[11px] uppercase tracking-[0.2em] text-white/55",children:["Target status: ",s.moderationStatus]}),s.moderationReason&&e.jsxs("p",{className:"mt-1 text-xs text-white/55",children:["Reason: ",s.moderationReason]}),e.jsx("p",{className:"mt-2 whitespace-pre-wrap text-sm text-white/85",children:s.body||"(no text)"}),s.mediaUrl&&e.jsx("a",{href:s.mediaUrl,target:"_blank",rel:"noreferrer noopener",className:"mt-2 inline-flex text-xs text-gold hover:text-gold/80",children:"Open media URL"})]}):e.jsx("p",{className:"text-xs text-white/55",children:"Target content not found (possibly deleted)."})}),s&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:H.map(r=>e.jsx("button",{type:"button",onClick:()=>B(t,r.value),className:"min-h-10 rounded-full border border-gold/45 px-4 py-2 text-[10px] uppercase tracking-[0.22em] text-gold",children:r.label},r.value))})]},t.id)}),!_.length&&e.jsx("div",{className:"rounded-3xl border border-white/15 bg-black/35 p-5 text-sm text-white/65",children:"No moderation reports in this filter."})]}),i&&e.jsx("p",{className:"mt-4 text-sm text-gold",children:i})]}):e.jsx("section",{className:"mx-auto w-full max-w-3xl px-4 pb-20 pt-8 sm:px-6",children:e.jsxs("div",{className:"rounded-3xl border border-white/15 bg-black/45 p-6",children:[e.jsxs("p",{className:"text-sm text-white/75",children:["Signed in as ",h,", but this account is not in `store_admins`."]}),e.jsx("button",{type:"button",onClick:async()=>{localStorage.removeItem(x),await I(),window.location.reload()},className:"mt-4 min-h-11 rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.24em] text-white/80",children:"Sign out"}),i&&e.jsx("p",{className:"mt-3 text-sm text-gold",children:i})]})}):e.jsx("section",{className:"mx-auto w-full max-w-3xl px-4 pb-20 pt-8 sm:px-6",children:e.jsxs("div",{className:"rounded-3xl border border-white/15 bg-black/45 p-6",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-gold/80",children:"Admin Moderation"}),e.jsx("h1",{className:"mt-2 font-display text-3xl",children:"Sign In"}),e.jsx("p",{className:"mt-2 text-sm text-white/70",children:"Use a magic link or federated login. Access is restricted to users in `store_admins`."}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("input",{value:j,onChange:t=>A(t.target.value),placeholder:"admin@theperforma.com",className:"min-h-11 flex-1 rounded-xl border border-white/20 bg-black/35 px-3 py-2 text-sm"}),e.jsx("button",{type:"button",onClick:$,disabled:w,className:"min-h-11 rounded-full bg-ember px-5 py-2 text-[11px] uppercase tracking-[0.22em] text-ink",children:w?"Sending...":"Magic Link"})]}),e.jsx("div",{className:"mt-4 flex flex-wrap gap-2",children:["google","github","facebook","apple"].map(t=>e.jsx("button",{type:"button",onClick:()=>L(t),className:"min-h-11 rounded-full border border-white/30 px-4 py-2 text-[11px] uppercase tracking-[0.22em] text-white/80",children:t},t))}),i&&e.jsx("p",{className:"mt-3 text-sm text-gold",children:i})]})})}export{re as default};
