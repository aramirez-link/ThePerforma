import{j as e}from"./jsx-runtime.TBa3i5EZ.js";import{r as a}from"./index.CVf8TyFT.js";import{d as x,p as C,i as f,l as xe,g as me,s as ee,a as pe,b as ue,r as ge,c as he,e as be,u as te}from"./fanVault.B59uIf8G.js";import"./index.BtUICepX.js";const se={google:{label:"Google",icon:"G"},apple:{label:"Apple",icon:"A"},facebook:{label:"Facebook",icon:"f"},github:{label:"GitHub",icon:"GH"}},fe="the-performa-engagement-v1",we="the-performa-live-dispatch-logs-v1";function ve(){const[p,B]=a.useState("register"),[M,F]=a.useState(""),[E,U]=a.useState(""),[L,D]=a.useState(""),[_,j]=a.useState(""),[R,k]=a.useState(x),[u,o]=a.useState(""),[ae,V]=a.useState(!0),[y,v]=a.useState(!1),[$,W]=a.useState(!1),[q,G]=a.useState(""),[T,I]=a.useState(!1),[r,re]=a.useState(null),[g,H]=a.useState([]),[Y,J]=a.useState([]),[K,Q]=a.useState(x),[h,z]=a.useState({points:0,streak:0,weeklySignal:0}),[b,S]=a.useState([]),[X,A]=a.useState(""),le=a.useMemo(()=>"".split(",").map(t=>t.trim().toLowerCase()).filter(Boolean),[]),d=async()=>{const t=await me();if(re(t),!t){H([]),J([]),j(""),k(x);return}f&&await ee(t.id);const[s,l]=await Promise.all([pe(),ue()]);H(s),J(l),j(t.bio||""),k(t.profileBadgeId||x),Q(t.profileBadgeId||x)};a.useEffect(()=>{(async()=>{V(!0),await d(),V(!1)})();const s=()=>{d()},l=()=>{if(f){ee().then(()=>d());return}d()};return window.addEventListener("fanvault:changed",s),window.addEventListener("performa:badges-updated",l),()=>{window.removeEventListener("fanvault:changed",s),window.removeEventListener("performa:badges-updated",l)}},[]);const P=!!(r?.email&&le.includes(r.email.toLowerCase()));a.useEffect(()=>{const t=async()=>{try{const s=JSON.parse(localStorage.getItem(fe)||"{}");z({points:Number(s.points||0),streak:Number(s.streak||0),weeklySignal:Number(s.weeklySignal||0)})}catch{z({points:0,streak:0,weeklySignal:0})}try{const s=localStorage.getItem("the-performa-operator-token-v1")||"",l="https://iahvjkodgrwatcpjdxna.supabase.co",m=l?new URL(l).hostname.split(".")[0]:"";if(s&&m&&P){const n=await fetch(`https://${m}.functions.supabase.co/go-live-blast`,{headers:{Authorization:`Bearer ${s}`}}),i=await n.json().catch(()=>({}));if(n.ok&&Array.isArray(i.rows)){S(i.rows.map(c=>({id:String(c.id),createdAt:c.created_at,status:c.status,title:c.title,streamUrl:c.stream_url,platform:c.platform,emailSent:Number(c.email_count||0),smsSent:Number(c.sms_count||0),opens:Number(c.opens||0),clicks:Number(c.clicks||0)}))),A("");return}A(i?.error?String(i.error):"Unable to load cloud dispatch metrics.")}}catch{A("Unable to load cloud dispatch metrics.")}try{const s=JSON.parse(localStorage.getItem(we)||"[]");Array.isArray(s)?S(s.slice(0,20)):S([])}catch{S([])}};return t(),window.addEventListener("performa:dispatch-log",t),window.addEventListener("storage",t),window.addEventListener("astro:after-swap",t),()=>{window.removeEventListener("performa:dispatch-log",t),window.removeEventListener("storage",t),window.removeEventListener("astro:after-swap",t)}},[P]),a.useEffect(()=>{if(!u)return;const t=window.setTimeout(()=>o(""),2200);return()=>window.clearTimeout(t)},[u]);const w=a.useMemo(()=>({gallery:g.filter(t=>t.type==="gallery"),watch:g.filter(t=>t.type==="watch"),listen:g.filter(t=>t.type==="listen")}),[g]),Z=a.useMemo(()=>C.find(t=>t.id===(r?.profileBadgeId||x))||C[0],[r]),O=a.useMemo(()=>{const t=(r?.bio||"").trim().length>=20,s=g.length>0,l=!!(r?.profileBadgeId&&r.profileBadgeId!==x);return{completed:[t,s,l].filter(Boolean).length,total:3,steps:[{label:"Add a profile bio (20+ chars)",done:t},{label:"Save at least one favorite",done:s},{label:"Pick a custom profile badge",done:l}]}},[g.length,r?.bio,r?.profileBadgeId]),ie=a.useMemo(()=>{const t=[{name:"Signal Runner",score:1140},{name:"Night Architect",score:980},{name:"Vault Operator",score:865}],s=h.points+h.weeklySignal+h.streak*14;return[...t,{name:r?.name||"You",score:s}].sort((l,m)=>m.score-l.score).slice(0,5)},[h.points,h.streak,h.weeklySignal,r?.name]),N=a.useMemo(()=>{const t=b.reduce((n,i)=>n+Number(i.emailSent||0),0),s=b.reduce((n,i)=>n+Number(i.smsSent||0),0),l=b.reduce((n,i)=>n+Number(i.opens||0),0),m=b.reduce((n,i)=>n+Number(i.clicks||0),0);return{email:t,sms:s,opens:l,clicks:m,count:b.length}},[b]),oe=async t=>{t.preventDefault(),v(!0);const s=p==="register"?await ge(M,E,L):await he(E,L);if(v(!1),!s.ok){o(s.error);return}"requiresConfirm"in s&&s.requiresConfirm?(o("Account created. Check your email to confirm, then log in."),B("login")):o(p==="register"?"Fan Vault created.":"Welcome back."),F(""),U(""),D(""),await d()},ne=async t=>{G(t);const s=await be(t);if(!s.ok){o(s.error),G("");return}o(`Redirecting to ${t}...`)},ce=async()=>{v(!0);const t=await te({bio:_,profileBadgeId:R});if(v(!1),!t){o("Please log in first.");return}o("Profile updated."),I(!1),await d()},de=async()=>{W(!0);const t=await te({profileBadgeId:K});if(W(!1),!t){o("Unable to update badge.");return}o("Badge updated."),await d()};return ae?e.jsx("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:e.jsx("p",{className:"text-sm text-white/70",children:"Loading Fan Vault..."})}):r?e.jsxs("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-1 h-11 w-11 rounded-xl border border-gold/40 bg-black/40 p-2 text-gold",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:Z.svg}})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.34em] text-gold/85",children:"Fan Vault Profile"}),e.jsx("h3",{className:"mt-2 font-display text-3xl",children:r.name}),e.jsx("p",{className:"mt-2 text-sm text-white/70",children:r.email}),e.jsxs("p",{className:"mt-1 text-xs text-white/45",children:["Mode: ",f?"Cloud Sync":"Local Device"]}),e.jsxs("p",{className:"mt-1 text-xs text-gold/80",children:["Badge: ",Z.label]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("select",{value:K,onChange:t=>Q(t.target.value),className:"rounded-full border border-white/20 bg-black/40 px-3 py-1 text-[11px] text-white/80",style:{color:"#f5f5f7",backgroundColor:"#111318"},children:C.map(t=>e.jsx("option",{value:t.id,style:{color:"#0f1116",backgroundColor:"#ffffff"},children:t.label},t.id))}),e.jsx("button",{type:"button",onClick:de,disabled:$,className:"rounded-full border border-gold/40 px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-gold min-h-10 disabled:opacity-60",children:$?"Saving":"Apply"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>I(t=>!t),className:"rounded-full border border-gold/40 px-5 py-2 text-xs uppercase tracking-[0.25em] text-gold min-h-11",children:T?"Close Edit":"Edit Profile"}),e.jsx("button",{type:"button",onClick:async()=>{await xe(),o("Signed out."),await d()},className:"rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.25em] text-white/75 min-h-11",children:"Sign Out"})]})]}),T&&e.jsxs("div",{className:"mt-6 rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Edit Profile Configuration"}),e.jsx("textarea",{value:_,onChange:t=>j(t.target.value),rows:3,className:"mt-3 w-full rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40",placeholder:"Add a short fan bio..."}),e.jsx("p",{className:"mt-4 text-xs uppercase tracking-[0.28em] text-white/55",children:"Profile Badge"}),e.jsx("div",{className:"mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3",children:C.map(t=>{const s=R===t.id;return e.jsxs("button",{type:"button",onClick:()=>k(t.id),className:`rounded-2xl border p-3 text-left transition ${s?"border-gold/60 bg-gold/10":"border-white/15 bg-black/40 hover:border-gold/35"}`,children:[e.jsx("div",{className:"mb-2 h-10 w-10 text-gold",dangerouslySetInnerHTML:{__html:t.svg}}),e.jsx("p",{className:"text-xs uppercase tracking-[0.22em] text-white/80",children:t.label}),e.jsx("p",{className:"mt-1 text-[11px] text-white/55",children:t.description}),e.jsx("p",{className:"mt-2 text-[10px] uppercase tracking-[0.2em] text-gold/85",children:t.tier})]},t.id)})}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{type:"button",disabled:y,onClick:ce,className:"rounded-full border border-gold/40 px-5 py-2 text-xs uppercase tracking-[0.25em] text-gold disabled:opacity-60",children:y?"Saving...":"Save Profile"}),e.jsx("button",{type:"button",onClick:()=>{j(r.bio||""),k(r.profileBadgeId||x),I(!1)},className:"rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.25em] text-white/75",children:"Cancel"})]})]}),e.jsxs("div",{className:"mt-8 grid gap-4 md:grid-cols-2",children:[e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Collected Badges"}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:Y.length?Y.map(t=>e.jsx("span",{className:"rounded-full border border-gold/45 px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-gold",children:t.label},t.id)):e.jsx("p",{className:"text-sm text-white/55",children:"No badges yet."})})]}),e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Saved Favorites"}),e.jsxs("p",{className:"mt-3 text-sm text-white/70",children:["Gallery ",w.gallery.length," | Watch ",w.watch.length," | Listen ",w.listen.length]})]})]}),e.jsxs("div",{className:"mt-8 grid gap-4 md:grid-cols-3",children:[e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Onboarding Missions"}),e.jsxs("p",{className:"mt-2 text-sm text-white/70",children:[O.completed,"/",O.total," complete"]}),e.jsx("ul",{className:"mt-3 space-y-2 text-xs text-white/75",children:O.steps.map(t=>e.jsxs("li",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{children:t.label}),e.jsx("span",{className:t.done?"text-gold":"text-white/45",children:t.done?"Done":"Pending"})]},t.label))})]}),e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Weekly Leaderboard"}),e.jsx("ul",{className:"mt-3 space-y-2 text-xs text-white/75",children:ie.map((t,s)=>e.jsxs("li",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{children:["#",s+1," ",t.name]}),e.jsx("span",{className:t.name===(r?.name||"You")?"text-gold":"text-white/60",children:t.score})]},`${t.name}-${s}`))})]}),P&&e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Performance Health"}),e.jsxs("p",{className:"mt-2 text-xs text-white/70",children:["Dispatches: ",N.count]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Emails sent: ",N.email]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["SMS sent: ",N.sms]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Opens tracked: ",N.opens]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Clicks tracked: ",N.clicks]}),X&&e.jsx("p",{className:"mt-2 text-[11px] text-gold",children:X})]})]}),e.jsx("div",{className:"mt-8 grid gap-4 md:grid-cols-3",children:["gallery","watch","listen"].map(t=>e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsxs("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:[t," Favorites"]}),e.jsxs("ul",{className:"mt-3 space-y-2 text-sm text-white/75",children:[w[t].slice(0,5).map(s=>e.jsx("li",{children:e.jsx("a",{href:s.href,className:"hover:text-gold",children:s.title})},`${s.type}-${s.id}`)),!w[t].length&&e.jsx("li",{className:"text-white/45",children:"None saved yet."})]})]},t))}),u&&e.jsx("p",{className:"mt-4 text-xs text-gold",children:u})]}):e.jsxs("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.34em] text-gold/85",children:"Fan Vault"}),e.jsx("h3",{className:"mt-2 font-display text-2xl",children:"Register or Log In"}),e.jsx("p",{className:"mt-2 text-sm text-white/70",children:f?"Create a cloud profile to sync favorites and badges across devices.":"Create a local profile on this device. Add Supabase keys to enable cloud sync."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>B("register"),className:`rounded-full border px-4 py-2 text-xs uppercase tracking-[0.25em] min-h-11 ${p==="register"?"border-gold/60 text-gold":"border-white/20 text-white/70"}`,children:"Register"}),e.jsx("button",{type:"button",onClick:()=>B("login"),className:`rounded-full border px-4 py-2 text-xs uppercase tracking-[0.25em] min-h-11 ${p==="login"?"border-gold/60 text-gold":"border-white/20 text-white/70"}`,children:"Log In"})]})]}),e.jsxs("form",{className:"mt-6 grid gap-4 md:grid-cols-2",onSubmit:oe,children:[p==="register"&&e.jsx("input",{value:M,onChange:t=>F(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Display Name",required:!0}),e.jsx("input",{value:E,onChange:t=>U(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Email",required:!0}),e.jsx("input",{value:L,onChange:t=>D(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Password",type:"password",required:!0}),e.jsx("button",{type:"submit",disabled:y,className:"rounded-full bg-ember px-6 py-3 text-xs uppercase tracking-[0.3em] text-ink min-h-11 disabled:opacity-60",children:y?"Working...":p==="register"?"Create Fan Vault":"Enter Vault"})]}),f&&e.jsxs("div",{className:"mt-5",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.24em] text-white/55",children:"Or continue with"}),e.jsx("div",{className:"mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:["google","apple","facebook","github"].map(t=>e.jsxs("button",{type:"button",onClick:()=>ne(t),disabled:!!q,className:"inline-flex min-h-11 items-center justify-center gap-2 rounded-full border border-white/25 bg-black/35 px-4 py-2 text-[11px] uppercase tracking-[0.22em] text-white/80 hover:border-gold/50 hover:text-gold disabled:opacity-60",children:[e.jsx("span",{className:"inline-flex h-4 w-4 items-center justify-center rounded-full border border-white/30 text-[9px] leading-none",children:se[t].icon}),e.jsx("span",{children:q===t?"Working...":se[t].label})]},t))})]}),u&&e.jsx("p",{className:"mt-3 text-xs text-gold",children:u}),e.jsxs("p",{className:"mt-3 text-xs text-white/45",children:["Mode: ",f?"Cloud Sync (Supabase)":"Local Device Only"]})]})}export{ve as default};
