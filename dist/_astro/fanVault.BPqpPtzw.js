import{c as be}from"./index.BtUICepX.js";const Qe=[{id:"visionary",label:"Visionary",tier:"core",description:"Future-facing selector with clear focus.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M10 32c5-9 13-14 22-14s17 5 22 14c-5 9-13 14-22 14s-17-5-22-14z" stroke="currentColor" stroke-width="2.8" stroke-linejoin="round"/><circle cx="32" cy="32" r="6.5" fill="currentColor"/><circle cx="36.5" cy="27.5" r="1.7" fill="white"/></svg>'},{id:"peace-maker",label:"Peace Maker",tier:"core",description:"Calm frequency and balanced energy.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M32 16v20M32 36L18.5 52M32 36L45.5 52" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><circle cx="32" cy="32" r="3" fill="currentColor"/></svg>'},{id:"rastafari",label:"Rastafari",tier:"elite",description:"Rasta identity with lionheart roots.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M24 24l3-4 3 4 2-4 2 4 2-4 2 4 3-4 3 4" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 43c0-6.5 5-11 11-11s11 4.5 11 11" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><circle cx="27.5" cy="33" r="1.8" fill="currentColor"/><circle cx="36.5" cy="33" r="1.8" fill="currentColor"/></svg>'},{id:"roots-man",label:"Roots Man",tier:"elite",description:"Throwback soul, classic roots spirit.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><circle cx="32" cy="26" r="8" stroke="currentColor" stroke-width="2.8"/><path d="M18 48c0-7 6-12 14-12s14 5 14 12" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><path d="M24 18h16" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/></svg>'},{id:"roots-gyal",label:"Roots Gyal",tier:"elite",description:"Throwback soul with queen presence.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><circle cx="32" cy="25.5" r="7.5" stroke="currentColor" stroke-width="2.8"/><path d="M18 48c0-7 6-12 14-12s14 5 14 12" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><path d="M24 19l8-6 8 6" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/></svg>'},{id:"vibes-youth",label:"Vibes Youth",tier:"core",description:"Hype man energy and crowd ignition.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M24 36l8-8 8 8" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 30h8M42 30h8M19 20l6 5M45 20l-6 5" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><circle cx="32" cy="42.5" r="2.4" fill="currentColor"/></svg>'},{id:"starigh-gangsta",label:"Straight Gangsta",tier:"legend",description:"Gangster badge, fearless and direct.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><rect x="20" y="22" width="24" height="10" rx="2" stroke="currentColor" stroke-width="2.8"/><path d="M20 27h24M24 42h16" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><path d="M28 32l-4 10M36 32l4 10" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/></svg>'},{id:"gyalis",label:"Gyalis",tier:"core",description:"Womanizer charm and social magnetism.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M26.5 41c-4.6-3.2-7.5-6.2-7.5-10.6 0-3.7 2.8-6.5 6.5-6.5 2.2 0 4 1 5.3 2.8 1.3-1.8 3.1-2.8 5.3-2.8 3.7 0 6.5 2.8 6.5 6.5 0 4.4-2.9 7.4-7.5 10.6" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><path d="M32 15v6M29 18h6" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/></svg>'},{id:"top-man",label:"Top Man",tier:"legend",description:"Boss man authority and leadership.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M17 44l5-16 10 8 10-8 5 16H17z" stroke="currentColor" stroke-width="2.8" stroke-linejoin="round"/><path d="M24 22l8-7 8 7" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/><path d="M29 45h6" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/></svg>'},{id:"top-gyal",label:"Top Gyal",tier:"legend",description:"Boss woman status with top-tier presence.",svg:'<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="25" stroke="currentColor" stroke-width="2.8"/><path d="M16 44l6-17 10 8 10-8 6 17H16z" stroke="currentColor" stroke-width="2.8" stroke-linejoin="round"/><circle cx="22" cy="24" r="2.6" fill="currentColor"/><circle cx="32" cy="17" r="2.6" fill="currentColor"/><circle cx="42" cy="24" r="2.6" fill="currentColor"/><path d="M24 47h16" stroke="currentColor" stroke-width="2.8" stroke-linecap="round"/></svg>'}],V="visionary",oe="fan-feed-media",O=4e3,ae=600,j=2048,ve=15*1024*1024,se=280,ne=120,ie=2,le=6,de=new Set(["image/jpeg","image/png","image/webp","image/gif","image/avif"]),Se=["nigger","faggot","kike","spic","chink","wetback","tranny","rape","child porn","bestiality","incest"],fe="the-performa-fan-vault-users-v1",z="the-performa-fan-vault-session-v1",Me="the-performa-badges-v1",ue="https://iahvjkodgrwatcpjdxna.supabase.co",Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhaHZqa29kZ3J3YXRjcGpkeG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDEwMzAsImV4cCI6MjA4NjI3NzAzMH0.0crxct3Pq52ZhymeTQ05_k8tZdg4KtYaZw92B7d_DKM",u=!!Y;let B=null,ce=!1;const Ie=()=>{if(typeof window>"u")return"";const e=new URL(window.location.href),t=e.hash.startsWith("#")?e.hash.slice(1):e.hash,o=new URLSearchParams(t),r=e.searchParams.get("error_description")||e.searchParams.get("error"),a=o.get("error_description")||o.get("error");return(r||a||"").trim()},X=()=>{if(typeof window>"u")return;const e=new URL(window.location.href),t=["code","error","error_code","error_description","access_token","refresh_token","expires_at","expires_in","token_type","provider_token","provider_refresh_token"];let o=!1;t.forEach(r=>{e.searchParams.has(r)&&(e.searchParams.delete(r),o=!0)}),e.hash&&(e.hash="",o=!0),o&&window.history.replaceState({},"",`${e.pathname}${e.search}${e.hash}`)},Ce=e=>{const t=typeof e.email=="string"?e.email.trim():"";if(t)return t.toLowerCase();const o=typeof e.user_metadata?.email=="string"?e.user_metadata.email.trim():"";if(o)return o.toLowerCase();const r=Array.isArray(e.identities)?e.identities:[];for(const a of r){const s=typeof a?.identity_data?.email=="string"?a.identity_data.email.trim():"";if(s)return s.toLowerCase()}return`${e.id}@fan.local`},d=()=>!u||!ue||!Y?null:B||(B=be(ue,Y,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),typeof window<"u"&&!ce&&(B.auth.onAuthStateChange(()=>{v()}),ce=!0),B),me=e=>({points:Math.max(0,Number(e.points||0)),streak:Math.max(0,Number(e.streak||0)),lastSeenDate:String(e.lastSeenDate||"").slice(0,10),dailyClaimDate:String(e.dailyClaimDate||"").slice(0,10),weekKey:String(e.weekKey||""),weeklySignal:Math.max(0,Number(e.weeklySignal||0)),visitedPaths:Array.isArray(e.visitedPaths)?e.visitedPaths.filter(t=>typeof t=="string").slice(0,128):[],reactions:{fire:Math.max(0,Number(e.reactions?.fire||0)),bolt:Math.max(0,Number(e.reactions?.bolt||0)),hands:Math.max(0,Number(e.reactions?.hands||0))},missions:{stageMode:!!e.missions?.stageMode,watchAndListen:!!e.missions?.watchAndListen,innerCircle:!!e.missions?.innerCircle}}),xe=e=>{const t=e?.reactions||{},o=e?.missions||{};return me({points:Number(e?.points||0),streak:Number(e?.streak||0),lastSeenDate:e?.last_seen_date||"",dailyClaimDate:e?.daily_claim_date||"",weekKey:e?.week_key||"",weeklySignal:Number(e?.weekly_signal||0),visitedPaths:Array.isArray(e?.visited_paths)?e.visited_paths:[],reactions:{fire:Number(t.fire||0),bolt:Number(t.bolt||0),hands:Number(t.hands||0)},missions:{stageMode:!!o.stageMode,watchAndListen:!!o.watchAndListen,innerCircle:!!o.innerCircle}})},g=()=>new Date().toISOString(),qe=()=>`vault_${Math.random().toString(36).slice(2,10)}_${Date.now().toString(36)}`,pe=(e,t)=>{if(typeof window>"u")return t;try{const o=localStorage.getItem(e);return o?JSON.parse(o):t}catch{return t}},Ne=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))},v=()=>{window.dispatchEvent(new CustomEvent("fanvault:changed"))},U=()=>pe(fe,[]),H=e=>{Ne(fe,e),v()},ge=()=>typeof window>"u"?"":localStorage.getItem(z)||"",D=()=>{const e=ge();if(!e)return null;const t=U().find(a=>a.id===e);if(!t)return null;const{password:o,...r}=t;return r},Ae=(e,t,o)=>{const r=e.trim(),a=t.trim().toLowerCase();if(!r||!a||!o)return{ok:!1,error:"All fields are required."};const s=U();if(s.some(p=>p.email===a))return{ok:!1,error:"Email is already registered on this device."};const n={id:qe(),name:r,email:a,password:o,createdAt:g(),bio:"",profileBadgeId:V,favorites:[]},l=[...s,n];H(l),localStorage.setItem(z,n.id),v();const{password:m,...c}=n;return{ok:!0,user:c}},Ee=(e,t)=>{const o=e.trim().toLowerCase(),r=U().find(n=>n.email===o&&n.password===t);if(!r)return{ok:!1,error:"Invalid email or password."};localStorage.setItem(z,r.id),v();const{password:a,...s}=r;return{ok:!0,user:s}},Fe=()=>{localStorage.removeItem(z),v()},Pe=e=>{const t=D();if(!t)return null;const r=U().map(l=>l.id===t.id?{...l,name:e.name?.trim()?e.name.trim():l.name,bio:typeof e.bio=="string"?e.bio:l.bio,profileBadgeId:typeof e.profileBadgeId=="string"?e.profileBadgeId:l.profileBadgeId}:l);H(r);const a=r.find(l=>l.id===t.id)||null;if(!a)return null;const{password:s,...n}=a;return n},Le=e=>{const t=D();if(!t)return{ok:!1,error:"Please register or log in to save favorites."};const r=U().map(n=>{if(n.id!==t.id)return n;const m=n.favorites.some(c=>c.type===e.type&&c.id===e.id)?n.favorites.filter(c=>!(c.type===e.type&&c.id===e.id)):[{...e,savedAt:g()},...n.favorites];return{...n,favorites:m}});return H(r),{ok:!0,favorited:r.find(n=>n.id===t.id).favorites.some(n=>n.type===e.type&&n.id===e.id)}},Ue=()=>{const e=D();return e?e.favorites:[]},_e=()=>pe(Me,[]),Be=e=>({type:e.type,id:e.item_id,title:e.title,href:e.href,image:e.image||void 0,savedAt:e.saved_at||g()}),ke=async(e,t,o="Fan")=>{const r=d();if(!r)return;const{data:a}=await r.from("fan_profiles").select("id,name,bio,created_at").eq("id",e).maybeSingle();a||await r.from("fan_profiles").insert({id:e,email:t,name:o,bio:""})},W=async(e,t)=>{const o=d();if(!o)return;const r=U(),a=ge(),s=r.find(n=>n.id===a)||r.find(n=>n.email===t.toLowerCase());s&&(await o.from("fan_profiles").upsert({id:e,email:t,name:s.name,bio:s.bio||""}),s.profileBadgeId&&await o.auth.updateUser({data:{profileBadgeId:s.profileBadgeId}}),s.favorites.length&&await o.from("fan_favorites").upsert(s.favorites.map(n=>({user_id:e,type:n.type,item_id:n.id,title:n.title,href:n.href,image:n.image||null,saved_at:n.savedAt})),{onConflict:"user_id,type,item_id"}),await he(e))},f=async()=>{const e=d();if(!e)return null;const{data:t}=await e.auth.getUser(),o=t.user;if(!o)return null;const r=Ce(o);await ke(o.id,r,o.user_metadata?.name||"Fan");const[{data:a},{data:s}]=await Promise.all([e.from("fan_profiles").select("id,name,email,bio,created_at").eq("id",o.id).maybeSingle(),e.from("fan_favorites").select("type,item_id,title,href,image,saved_at").eq("user_id",o.id).order("saved_at",{ascending:!1})]);return{id:o.id,name:a?.name||o.user_metadata?.name||"Fan",email:a?.email||r,createdAt:a?.created_at||o.created_at||g(),bio:a?.bio||"",profileBadgeId:o.user_metadata?.profileBadgeId||V,favorites:(s||[]).map(Be)}},Xe=async()=>{if(!u)return{ok:!0,completed:!1};const e=d();if(!e)return{ok:!1,error:"Vault is not configured."};if(typeof window>"u")return{ok:!0,completed:!1};const t=Ie();if(t)return X(),{ok:!1,error:t};const r=new URL(window.location.href).searchParams.get("code");if(!r)return{ok:!0,completed:!1};const{data:a}=await e.auth.getSession();if(a.session)return X(),v(),{ok:!0,completed:!0};const{error:s}=await e.auth.exchangeCodeForSession(r);if(X(),s)return{ok:!1,error:s.message};const n=await f();return n&&await W(n.id,n.email),v(),{ok:!0,completed:!0}},Ye=async()=>u?f():D(),He=async(e,t,o)=>{if(!u)return Ae(e,t,o);const r=d();if(!r)return{ok:!1,error:"Vault is not configured."};const a=e.trim(),s=t.trim().toLowerCase();if(!a||!s||!o)return{ok:!1,error:"All fields are required."};const{data:n,error:l}=await r.auth.signUp({email:s,password:o,options:{data:{name:a,profileBadgeId:V}}});if(l)return{ok:!1,error:l.message};if(!n.user)return{ok:!1,error:"Signup failed. Try again."};if(await ke(n.user.id,s,a),await W(n.user.id,s),!n.session)return v(),{ok:!0,requiresConfirm:!0,user:{id:n.user.id,name:a,email:s,createdAt:n.user.created_at||g(),bio:"",profileBadgeId:V,favorites:[]}};const m=await f();return v(),{ok:!0,user:m}},We=async(e,t)=>{if(!u)return Ee(e,t);const o=d();if(!o)return{ok:!1,error:"Vault is not configured."};const{error:r}=await o.auth.signInWithPassword({email:e.trim().toLowerCase(),password:t});if(r)return{ok:!1,error:r.message};const a=await f();return a?(await W(a.id,a.email),v(),{ok:!0,user:a}):{ok:!1,error:"Could not load your profile."}},Ze=async e=>{if(!u)return{ok:!1,error:"Cloud auth is not configured."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=typeof window<"u"?new URL("/fan-club",window.location.origin).toString():void 0,{error:r}=await t.auth.signInWithOAuth({provider:e,options:{redirectTo:o}});return r?{ok:!1,error:r.message}:{ok:!0,redirected:!0}},er=async()=>{if(!u){Fe();return}const e=d();e&&(await e.auth.signOut(),v())},rr=async e=>{if(!u)return Pe(e);const t=d();if(!t)return null;const o=await f();if(!o)return null;await t.from("fan_profiles").upsert({id:o.id,email:o.email,name:e.name?.trim()?e.name.trim():o.name,bio:typeof e.bio=="string"?e.bio:o.bio}),typeof e.profileBadgeId=="string"&&await t.auth.updateUser({data:{profileBadgeId:e.profileBadgeId}});const r=await f();return v(),r},tr=async(e,t)=>{if(!u){const s=D();return s?s.favorites.some(n=>n.type===e&&n.id===t):!1}const o=d();if(!o)return!1;const r=await f();if(!r)return!1;const{data:a}=await o.from("fan_favorites").select("item_id").eq("user_id",r.id).eq("type",e).eq("item_id",t).maybeSingle();return!!a},or=async e=>{if(!u)return Le(e);const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Please register or log in to save favorites."};const{data:r}=await t.from("fan_favorites").select("item_id").eq("user_id",o.id).eq("type",e.type).eq("item_id",e.id).maybeSingle();return r?(await t.from("fan_favorites").delete().eq("user_id",o.id).eq("type",e.type).eq("item_id",e.id),v(),{ok:!0,favorited:!1}):(await t.from("fan_favorites").upsert({user_id:o.id,type:e.type,item_id:e.id,title:e.title,href:e.href,image:e.image||null,saved_at:g()},{onConflict:"user_id,type,item_id"}),v(),{ok:!0,favorited:!0})},ar=async()=>{if(!u)return Ue();const e=await f();return e?e.favorites:[]},he=async e=>{if(!u)return;const t=d();if(!t)return;const o=_e();if(!o.length)return;let r=e;r||(r=(await f())?.id),r&&await t.from("fan_badges").upsert(o.map(a=>({user_id:r,badge_id:a.id,label:a.label,tier:a.tier||null,tip:a.tip||null,updated_at:g()})),{onConflict:"user_id,badge_id"})},sr=async()=>{if(!u)return _e();const e=d();if(!e)return[];const t=await f();if(!t)return[];await he(t.id);const{data:o}=await e.from("fan_badges").select("badge_id,label,tier,tip").eq("user_id",t.id).order("updated_at",{ascending:!1});return(o||[]).map(r=>({id:r.badge_id,label:r.label,tier:r.tier||void 0,tip:r.tip||void 0}))},Re=()=>({points:120,streak:1,lastSeenDate:new Date().toISOString().slice(0,10),dailyClaimDate:"",weekKey:"",weeklySignal:0,visitedPaths:[],reactions:{fire:0,bolt:0,hands:0},missions:{stageMode:!1,watchAndListen:!1,innerCircle:!1}}),Te=async()=>{if(!u)return null;const e=d();if(!e)return null;const t=await f();if(!t)return null;const{data:o}=await e.from("fan_engagement_profiles").select("points,streak,last_seen_date,daily_claim_date,week_key,weekly_signal,visited_paths,reactions,missions").eq("user_id",t.id).maybeSingle();return o?xe(o):null},De=async e=>{if(!u)return!1;const t=d();if(!t)return!1;const o=await f();if(!o)return!1;const r=me(e),{error:a}=await t.from("fan_engagement_profiles").upsert({user_id:o.id,display_name:o.name||"Fan",points:r.points,streak:r.streak,last_seen_date:r.lastSeenDate||null,daily_claim_date:r.dailyClaimDate||null,week_key:r.weekKey,weekly_signal:r.weeklySignal,visited_paths:r.visitedPaths,reactions:r.reactions,missions:r.missions,updated_at:g()},{onConflict:"user_id"});return!a},nr=async()=>{const e=await Te();if(e)return e;const t=Re();return await De(t)?t:null},ir=async(e=10)=>{if(!u)return[];const t=d();if(!t)return[];const{data:o}=await t.from("fan_engagement_profiles").select("user_id,display_name,points,streak,weekly_signal,updated_at").limit(Math.max(1,Math.min(50,e)));return(o||[]).map(r=>({userId:r.user_id,displayName:r.display_name||"Fan",points:Number(r.points||0),streak:Number(r.streak||0),weeklySignal:Number(r.weekly_signal||0),score:Number(r.points||0)+Number(r.weekly_signal||0)+Number(r.streak||0)*17,updatedAt:r.updated_at||g()})).sort((r,a)=>a.score-r.score).slice(0,Math.max(1,Math.min(50,e)))},lr=e=>{if(!u)return null;const t=d();if(!t)return null;const o=t.channel("fan-engagement-leaderboard").on("postgres_changes",{event:"*",schema:"public",table:"fan_engagement_profiles"},()=>e()).subscribe();return()=>{t.removeChannel(o)}},Ve=(e,t)=>({id:String(e.id),postId:String(e.post_id),userId:e.user_id,authorName:t.get(e.user_id)||"Fan",body:e.body||"",moderationStatus:e.moderation_status||"approved",moderationReason:e.moderation_reason||null,createdAt:e.created_at||g()}),Oe=(e,t,o,r,a,s)=>({id:String(e.id),userId:e.user_id,authorName:t.get(e.user_id)||"Fan",body:e.body||"",mediaUrl:e.media_url||null,mediaType:e.media_type||null,moderationStatus:e.moderation_status||"approved",moderationReason:e.moderation_reason||null,isNsfw:!!e.is_nsfw,shareCount:Number(e.share_count||0),likeCount:r,viewerHasLiked:a,poll:s,comments:o,createdAt:e.created_at||g(),updatedAt:e.updated_at||e.created_at||g()}),T=e=>{try{const t=new URL(e);return t.protocol!=="https:"&&t.protocol!=="http:"?null:t.toString()}catch{return null}},je=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),R=e=>{const t=e.toLowerCase();for(const o of Se)if(new RegExp(`\\b${je(o.toLowerCase())}\\b`,"i").test(t))return o;return null},ze=()=>"",Z=async e=>{const t=ze();if(!t)return null;try{const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)return null;const r=await o.json(),a=r?.status||"pending",s=typeof r?.reason=="string"?r.reason:null;return["pending","approved","rejected","flagged"].includes(a)?{status:a,reason:s}:null}catch{return null}},$=async()=>{const e=d();if(!e)return!1;const{data:t,error:o}=await e.from("fan_feed_settings").select("moderation_enabled").eq("id",1).maybeSingle();return o?!1:!!t?.moderation_enabled},dr=async()=>u?d()?{ok:!0,enabled:await $()}:{ok:!1,error:"Vault is not configured."}:{ok:!0,enabled:!1},ur=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};const{error:r}=await t.from("fan_feed_settings").upsert({id:1,moderation_enabled:!!e,updated_by:o.id,updated_at:g()});if(r)return{ok:!1,error:r.message};if(!e){const a=await t.from("fan_feed_posts").update({moderation_status:"approved",moderation_reason:null}).eq("moderation_status","pending");if(a.error&&!q(a.error,"moderation_status"))return{ok:!1,error:a.error.message};const s=await t.from("fan_feed_comments").update({moderation_status:"approved",moderation_reason:null}).eq("moderation_status","pending");if(s.error&&!q(s.error,"moderation_status"))return{ok:!1,error:s.error.message}}return{ok:!0,enabled:!!e}},$e=e=>e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255?"image/jpeg":e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71?"image/png":e.length>=6&&e[0]===71&&e[1]===73&&e[2]===70?"image/gif":e.length>=12&&e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80?"image/webp":e.length>=12&&e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112&&e[8]===97&&e[9]===118&&e[10]===105&&(e[11]===102||e[11]===115)?"image/avif":null,Ke={"image/jpeg":"jpg","image/png":"png","image/webp":"webp","image/gif":"gif","image/avif":"avif"},q=(e,t)=>{const o=String(e?.message||"").toLowerCase(),r=t.toLowerCase(),a=o.includes("schema cache")&&o.includes("column")&&o.includes(r),s=o.includes("column")&&o.includes("does not exist")&&o.includes(r);return a||s},N=(e,t)=>{const o=String(e?.message||"").toLowerCase(),r=t.toLowerCase(),a=r.replace("public.",""),s=o.includes("relation")&&o.includes("does not exist")&&o.includes(r),n=o.includes("could not find the table")&&(o.includes(a)||o.includes(r)),l=o.includes("schema cache")&&o.includes("table")&&(o.includes(a)||o.includes(r));return s||n||l},ee=e=>{if(!e||typeof e!="object")return{};const t=e,o=String(t.cardTone||"").toLowerCase(),r=o==="ember"||o==="gold"||o==="cyan"||o==="neutral"?o:void 0,a=typeof t.accentColor=="string"?t.accentColor.slice(0,32):void 0,s=typeof t.label=="string"?t.label.slice(0,64):void 0;return{accentColor:a,label:s,cardTone:r}},cr=async(e=30)=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to view the feed."};let{data:r,error:a}=await t.from("fan_feed_posts").select("id,user_id,body,media_url,media_type,moderation_status,moderation_reason,is_nsfw,share_count,created_at,updated_at").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(100,e)));if(a&&(q(a,"is_nsfw")||q(a,"moderation_status")||q(a,"moderation_reason"))){const i=await t.from("fan_feed_posts").select("id,user_id,body,media_url,media_type,share_count,created_at,updated_at").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(100,e)));r=i.data,a=i.error}if(a)return{ok:!1,error:a.message};const n=r||[];if(!n.length)return{ok:!0,posts:[]};const l=n.map(i=>Number(i.id)),m=Array.from(new Set(n.map(i=>i.user_id))),[{data:c},{data:p}]=await Promise.all([t.from("fan_profiles").select("id,name").in("id",m),t.from("fan_feed_likes").select("post_id,user_id").in("post_id",l)]);let{data:_,error:y}=await t.from("fan_feed_comments").select("id,post_id,user_id,body,moderation_status,moderation_reason,created_at").in("post_id",l).order("created_at",{ascending:!0});if(y&&(q(y,"moderation_status")||q(y,"moderation_reason"))){const i=await t.from("fan_feed_comments").select("id,post_id,user_id,body,created_at").in("post_id",l).order("created_at",{ascending:!0});_=i.data,y=i.error}if(y)return{ok:!1,error:y.message};const S=Array.from(new Set((_||[]).map(i=>i.user_id))).filter(i=>!m.includes(i));let b=[];if(S.length){const{data:i}=await t.from("fan_profiles").select("id,name").in("id",S);b=i||[]}const A=new Map;(c||[]).forEach(i=>A.set(i.id,i.name||"Fan")),b.forEach(i=>A.set(i.id,i.name||"Fan"));const k=new Map;(_||[]).forEach(i=>{const w=String(i.post_id),P=k.get(w)||[];P.push(Ve(i,A)),k.set(w,P)});const x=new Map,M=new Set;(p||[]).forEach(i=>{const w=String(i.post_id);x.set(w,(x.get(w)||0)+1),i.user_id===o.id&&M.add(w)});const I=new Map;let E=[];const F=await t.from("fan_feed_polls").select("post_id,question,allow_multiple,expires_at").in("post_id",l);if(!F.error)E=F.data||[];else if(!N(F.error,"fan_feed_polls"))return{ok:!1,error:F.error.message};if(E.length){const i=E.map(h=>Number(h.post_id)),[w,P]=await Promise.all([t.from("fan_feed_poll_options").select("id,poll_post_id,label,image_url,position").in("poll_post_id",i).order("position",{ascending:!0}).order("id",{ascending:!0}),t.from("fan_feed_poll_votes").select("poll_post_id,option_id,user_id").in("poll_post_id",i)]);if(w.error&&!N(w.error,"fan_feed_poll_options"))return{ok:!1,error:w.error.message};if(P.error&&!N(P.error,"fan_feed_poll_votes"))return{ok:!1,error:P.error.message};const we=w.data||[],ye=P.data||[],G=new Map,re=new Set,J=new Map,te=new Set;ye.forEach(h=>{const C=String(h.option_id),L=String(h.poll_post_id);G.set(C,(G.get(C)||0)+1),J.set(L,(J.get(L)||0)+1),h.user_id===o.id&&(re.add(C),te.add(L))});const Q=new Map;we.forEach(h=>{const C=String(h.poll_post_id),L=Q.get(C)||[];L.push({id:String(h.id),label:String(h.label||""),imageUrl:h.image_url||null,position:Number(h.position||0),voteCount:G.get(String(h.id))||0,viewerVoted:re.has(String(h.id))}),Q.set(C,L)}),E.forEach(h=>{const C=String(h.post_id);I.set(C,{question:String(h.question||""),allowMultiple:!!h.allow_multiple,expiresAt:h.expires_at||null,totalVotes:J.get(C)||0,viewerHasVoted:te.has(C),options:Q.get(C)||[]})})}return{ok:!0,posts:n.map(i=>Oe(i,A,k.get(String(i.id))||[],x.get(String(i.id))||0,M.has(String(i.id)),I.get(String(i.id))||null))}},fr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to publish posts."};const r=(e.body||"").trim(),a=e.poll||null,s=(e.mediaUrl||"").trim();if(!r&&!s&&!a)return{ok:!1,error:"Add text, a media link, or a poll to publish."};if(r.length>O)return{ok:!1,error:`Post is too long. Max ${O} characters.`};if(s.length>j)return{ok:!1,error:`Media URL is too long. Max ${j} characters.`};const n=s?T(s):null;if(s&&!n)return{ok:!1,error:"Media URL must start with http:// or https://."};if(e.mediaType&&!["image","video","link"].includes(e.mediaType))return{ok:!1,error:"Invalid media type."};let l=null;if(a){const k=String(a.question||"").trim();if(!k)return{ok:!1,error:"Poll question is required."};if(k.length>se)return{ok:!1,error:`Poll question is too long. Max ${se} characters.`};if(R(k))return{ok:!1,error:"Poll question blocked by community safety filter."};const I=(Array.isArray(a.options)?a.options:[]).map((i,w)=>({label:String(i?.label||"").trim(),imageUrlRaw:String(i?.imageUrl||"").trim(),position:w})).filter(i=>i.label.length>0);if(I.length<ie||I.length>le)return{ok:!1,error:`Poll must have ${ie}-${le} options.`};for(const i of I){if(i.label.length>ne)return{ok:!1,error:`Poll option is too long. Max ${ne} characters.`};if(R(i.label))return{ok:!1,error:"Poll option blocked by community safety filter."}}const E=[];for(const i of I){const w=i.imageUrlRaw?T(i.imageUrlRaw):null;if(i.imageUrlRaw&&!w)return{ok:!1,error:"Poll option image URL must start with http:// or https://."};E.push({label:i.label,imageUrl:w,position:i.position})}let F=null;if(a.expiresAt){const i=Date.parse(String(a.expiresAt));if(Number.isNaN(i))return{ok:!1,error:"Invalid poll end date."};if(i<=Date.now())return{ok:!1,error:"Poll end date must be in the future."};F=new Date(i).toISOString()}l={question:k,allowMultiple:!!a.allowMultiple,expiresAt:F,options:E}}if(R(r))return{ok:!1,error:"Post blocked by community safety filter."};let c="approved",p=null;if(await $()){const k=await Z({type:"post",body:r,mediaUrl:n,userId:o.id});if(k?(p=k.reason,k.status==="rejected"?c="rejected":c=k.status):c="pending",c==="rejected")return{ok:!1,error:p||"Post rejected by moderation policy."}}const y={user_id:o.id,body:r,media_url:n||null,media_type:e.mediaType||(n?"link":null),moderation_status:c,moderation_reason:p,is_nsfw:!1,share_count:0},K=async k=>await t.from("fan_feed_posts").insert(k).select("id").single();let S=null,b=null;const A=await K(y);if(b=A.error,b||(S=Number(A.data?.id)),b){if(b.code==="42501"||/row-level security/i.test(b.message||"")||/policy/i.test(b.message||"")){const I=await K({...y,moderation_status:"pending",moderation_reason:null});I.error?b=I.error:S=Number(I.data?.id)}if(!(q(b,"is_nsfw")||q(b,"moderation_status")||q(b,"moderation_reason")))return{ok:!1,error:b.message};const M=await t.from("fan_feed_posts").insert({user_id:o.id,body:r,media_url:n||null,media_type:e.mediaType||(n?"link":null),share_count:0}).select("id").single();if(M.error)return{ok:!1,error:M.error.message};S=Number(M.data?.id)}if(l&&S){const k=await t.from("fan_feed_polls").insert({post_id:S,question:l.question,allow_multiple:l.allowMultiple,expires_at:l.expiresAt});if(k.error)return await t.from("fan_feed_posts").delete().eq("id",S).eq("user_id",o.id),N(k.error,"fan_feed_polls")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:k.error.message};const x=await t.from("fan_feed_poll_options").insert(l.options.map(M=>({poll_post_id:S,label:M.label,image_url:M.imageUrl,position:M.position})));if(x.error)return await t.from("fan_feed_posts").delete().eq("id",S).eq("user_id",o.id),N(x.error,"fan_feed_poll_options")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:x.error.message}}return{ok:!0,created:!0}},mr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to vote."};const r=Number(e.postId);if(!Number.isFinite(r))return{ok:!1,error:"Invalid poll id."};const a=Array.from(new Set((e.optionIds||[]).map(_=>Number(_)).filter(Number.isFinite)));if(!a.length)return{ok:!1,error:"Pick at least one option."};const{data:s,error:n}=await t.from("fan_feed_polls").select("post_id,allow_multiple,expires_at").eq("post_id",r).maybeSingle();if(n)return N(n,"fan_feed_polls")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:n.message};if(!s)return{ok:!1,error:"Poll not found."};if(!s.allow_multiple&&a.length>1)return{ok:!1,error:"This poll only allows one selection."};if(s.expires_at&&Date.parse(String(s.expires_at))<=Date.now())return{ok:!1,error:"This poll has ended."};const{data:l,error:m}=await t.from("fan_feed_poll_options").select("id").eq("poll_post_id",r).in("id",a);if(m)return N(m,"fan_feed_poll_options")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:m.message};if((l||[]).length!==a.length)return{ok:!1,error:"One or more poll options are invalid."};const c=await t.from("fan_feed_poll_votes").delete().eq("poll_post_id",r).eq("user_id",o.id);if(c.error)return N(c.error,"fan_feed_poll_votes")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:c.error.message};const p=await t.from("fan_feed_poll_votes").insert(a.map(_=>({poll_post_id:r,option_id:_,user_id:o.id})));return p.error?N(p.error,"fan_feed_poll_votes")?{ok:!1,error:"Poll feature is not fully installed yet. Run the latest fan_vault_schema.sql and reload Supabase schema cache."}:{ok:!1,error:p.error.message}:{ok:!0,voted:!0}},pr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to edit posts."};const r=Number(e.postId);if(!Number.isFinite(r))return{ok:!1,error:"Invalid post id."};const a=(e.body||"").trim(),s=(e.mediaUrl||"").trim();if(!a&&!s)return{ok:!1,error:"Post cannot be empty."};if(a.length>O)return{ok:!1,error:`Post is too long. Max ${O} characters.`};if(s.length>j)return{ok:!1,error:`Media URL is too long. Max ${j} characters.`};const n=s?T(s):null;if(s&&!n)return{ok:!1,error:"Media URL must start with http:// or https://."};if(e.mediaType&&!["image","video","link"].includes(e.mediaType))return{ok:!1,error:"Invalid media type."};if(R(a))return{ok:!1,error:"Post blocked by community safety filter."};let m="approved",c=null;if(await $()){const y=await Z({type:"post",body:a,mediaUrl:n,userId:o.id});if(y?(c=y.reason,y.status==="rejected"?m="rejected":m=y.status):m="pending",m==="rejected")return{ok:!1,error:c||"Post rejected by moderation policy."}}const{error:_}=await t.from("fan_feed_posts").update({body:a,media_url:n||null,media_type:e.mediaType||(n?"link":null),moderation_status:m,moderation_reason:c}).eq("id",r).eq("user_id",o.id);return _?{ok:!1,error:_.message}:{ok:!0,updated:!0}},gr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to delete posts."};const r=Number(e);if(!Number.isFinite(r))return{ok:!1,error:"Invalid post id."};const{error:a}=await t.from("fan_feed_posts").delete().eq("id",r).eq("user_id",o.id);return a?{ok:!1,error:a.message}:{ok:!0,deleted:!0}},_r=async(e,t)=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const o=d();if(!o)return{ok:!1,error:"Vault is not configured."};const r=await f();if(!r)return{ok:!1,error:"Log in to Fan Vault to comment."};const a=t.trim();if(!a)return{ok:!1,error:"Comment cannot be empty."};if(a.length>ae)return{ok:!1,error:`Comment is too long. Max ${ae} characters.`};if(R(a))return{ok:!1,error:"Comment blocked by community safety filter."};let n="approved",l=null;if(await $()){const _=await Z({type:"comment",body:a,userId:r.id});if(_?(l=_.reason,_.status==="rejected"?n="rejected":n=_.status):n="pending",n==="rejected")return{ok:!1,error:l||"Comment rejected by moderation policy."}}const c={post_id:Number(e),user_id:r.id,body:a,moderation_status:n,moderation_reason:l},{error:p}=await o.from("fan_feed_comments").insert(c);return p?(p.code==="42501"||/row-level security/i.test(p.message||"")||/policy/i.test(p.message||""))&&!(await o.from("fan_feed_comments").insert({...c,moderation_status:"pending",moderation_reason:null})).error?{ok:!0,created:!0}:{ok:!1,error:p.message}:{ok:!0,created:!0}},kr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to like posts."};const r=Number(e),{data:a}=await t.from("fan_feed_likes").select("post_id").eq("post_id",r).eq("user_id",o.id).maybeSingle();if(a){const{error:n}=await t.from("fan_feed_likes").delete().eq("post_id",r).eq("user_id",o.id);return n?{ok:!1,error:n.message}:{ok:!0,liked:!1}}const{error:s}=await t.from("fan_feed_likes").insert({post_id:r,user_id:o.id});return s?{ok:!1,error:s.message}:{ok:!0,liked:!0}},hr=async e=>{if(!u)return{ok:!1,error:"Fan Feed requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};if(!await f())return{ok:!1,error:"Log in to Fan Vault to share posts."};const r=Number(e),{data:a,error:s}=await t.from("fan_feed_posts").select("id,share_count").eq("id",r).maybeSingle();if(s)return{ok:!1,error:s.message};if(!a)return{ok:!1,error:"Post not found."};const{error:n}=await t.from("fan_feed_posts").update({share_count:Number(a.share_count||0)+1}).eq("id",r);return n?{ok:!1,error:n.message}:{ok:!0,shared:!0}},wr=async e=>{if(!u)return{ok:!1,error:"Reporting requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to report content."};const r=(e.details||"").trim(),a=(e.reasonCode||"").trim().toLowerCase();if(!a)return{ok:!1,error:"Select a report reason."};if(!["hate","sexual","harassment","violence","spam","other"].includes(a))return{ok:!1,error:"Invalid report reason."};const s=e.targetType,n=Number(e.targetId);if(!Number.isFinite(n))return{ok:!1,error:"Invalid report target."};const{error:l}=await t.from("fan_feed_reports").insert({reporter_user_id:o.id,target_type:s,target_id:n,reason_code:a,details:r||null,status:"open"});return l?{ok:!1,error:l.message}:{ok:!0,created:!0}},Ge=async(e=100)=>{if(!u)return{ok:!1,error:"Moderation queue requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};if(!await f())return{ok:!1,error:"Log in required."};const{data:r,error:a}=await t.from("fan_feed_reports").select("*").order("created_at",{ascending:!1}).limit(Math.max(1,Math.min(250,e)));return a?{ok:!1,error:a.message}:{ok:!0,rows:r||[]}},yr=async(e=100)=>{const t=await Ge(e);return t.ok?{ok:!0,reports:(t.rows||[]).map(o=>({id:Number(o.id),reporterUserId:o.reporter_user_id,targetType:o.target_type,targetId:String(o.target_id),reasonCode:o.reason_code,details:o.details||null,status:o.status||"open",reviewedBy:o.reviewed_by||null,reviewedAt:o.reviewed_at||null,createdAt:o.created_at||g()}))}:t},br=async e=>{if(!u)return{ok:!1,error:"Moderation update requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};const r=Number(e.targetId);if(!Number.isFinite(r))return{ok:!1,error:"Invalid target id."};if(!["pending","approved","rejected","flagged"].includes(e.status))return{ok:!1,error:"Invalid moderation status."};const a=e.targetType==="post"?"fan_feed_posts":"fan_feed_comments",{error:s}=await t.from(a).update({moderation_status:e.status,moderation_reason:e.reason||null,moderated_by:o.id,moderated_at:g()}).eq("id",r);return s?{ok:!1,error:s.message}:{ok:!0,updated:!0}},vr=async e=>{if(!u)return{ok:!1,error:"Moderation update requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};if(!["open","reviewed","resolved","dismissed"].includes(e.status))return{ok:!1,error:"Invalid report status."};const{error:r}=await t.from("fan_feed_reports").update({status:e.status,reviewed_by:o.id,reviewed_at:g()}).eq("id",e.reportId);return r?{ok:!1,error:r.message}:{ok:!0,updated:!0}},Sr=async()=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const e=d();if(!e)return{ok:!1,error:"Vault is not configured."};const{data:t,error:o}=await e.from("fan_feed_trivia_questions").select("id,prompt,options,correct_option_index,category,difficulty,image_url,explanation,is_active,created_by,created_at,updated_at").order("created_at",{ascending:!1});return o?{ok:!1,error:o.message}:{ok:!0,questions:(t||[]).map(r=>({id:String(r.id),prompt:String(r.prompt||""),options:Array.isArray(r.options)?r.options.map(a=>String(a||"")):[],correctOptionIndex:Number(r.correct_option_index||0),category:String(r.category||"general"),difficulty:String(r.difficulty||"medium"),imageUrl:r.image_url||null,explanation:r.explanation||null,isActive:!!r.is_active,createdBy:r.created_by||null,createdAt:r.created_at||g(),updatedAt:r.updated_at||r.created_at||g()}))}},Mr=async e=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};const r=String(e.prompt||"").trim(),a=(e.options||[]).map(_=>String(_||"").trim()).filter(Boolean),s=Number(e.correctOptionIndex||0),n=String(e.category||"general").trim()||"general",l=String(e.difficulty||"medium").toLowerCase(),m=String(e.imageUrl||"").trim(),c=m?T(m):null;if(!r)return{ok:!1,error:"Question prompt is required."};if(a.length<2||a.length>6)return{ok:!1,error:"Provide 2 to 6 options."};if(!Number.isFinite(s)||s<0||s>=a.length)return{ok:!1,error:"Correct option index is out of range."};if(l!=="easy"&&l!=="medium"&&l!=="hard")return{ok:!1,error:"Invalid difficulty."};if(m&&!c)return{ok:!1,error:"Image URL must start with http:// or https://."};const{error:p}=await t.from("fan_feed_trivia_questions").insert({prompt:r,options:a,correct_option_index:s,category:n,difficulty:l,image_url:c,explanation:e.explanation||null,is_active:!0,created_by:o.id});return p?{ok:!1,error:p.message}:{ok:!0,created:!0}},Ir=async e=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=(e.options||[]).map(n=>String(n||"").trim()).filter(Boolean);if(o.length<2||o.length>6)return{ok:!1,error:"Provide 2 to 6 options."};const r=String(e.imageUrl||"").trim(),a=r?T(r):null;if(r&&!a)return{ok:!1,error:"Image URL must start with http:// or https://."};const{error:s}=await t.from("fan_feed_trivia_questions").update({prompt:String(e.prompt||"").trim(),options:o,correct_option_index:Number(e.correctOptionIndex||0),category:String(e.category||"general").trim()||"general",difficulty:String(e.difficulty||"medium").toLowerCase(),image_url:a,explanation:e.explanation||null,is_active:e.isActive!==void 0?!!e.isActive:!0,updated_at:g()}).eq("id",Number(e.id));return s?{ok:!1,error:s.message}:{ok:!0,updated:!0}},Cr=async()=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const e=d();if(!e)return{ok:!1,error:"Vault is not configured."};const{data:t,error:o}=await e.from("fan_feed_trivia_campaigns").select("id,title,status,question_ids,schedule_timezone,start_at,end_at,cadence_minutes,post_duration_minutes,next_run_at,last_run_at,look_and_feel,created_by,updated_by,created_at,updated_at").order("created_at",{ascending:!1});return o?{ok:!1,error:o.message}:{ok:!0,campaigns:(t||[]).map(r=>({id:String(r.id),title:String(r.title||""),status:String(r.status||"draft"),questionIds:Array.isArray(r.question_ids)?r.question_ids.map(a=>String(a)):[],scheduleTimezone:String(r.schedule_timezone||"UTC"),startAt:r.start_at||g(),endAt:r.end_at||null,cadenceMinutes:Number(r.cadence_minutes||60),postDurationMinutes:Number(r.post_duration_minutes||10),nextRunAt:r.next_run_at||g(),lastRunAt:r.last_run_at||null,lookAndFeel:ee(r.look_and_feel),createdBy:r.created_by||null,updatedBy:r.updated_by||null,createdAt:r.created_at||g(),updatedAt:r.updated_at||r.created_at||g()}))}},xr=async e=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};const r=String(e.title||"").trim(),a=Array.from(new Set((e.questionIds||[]).map(_=>Number(_)).filter(Number.isFinite)));if(!r)return{ok:!1,error:"Campaign title is required."};if(!a.length)return{ok:!1,error:"Select at least one trivia question."};const s=Date.parse(String(e.startAt||""));if(Number.isNaN(s))return{ok:!1,error:"Invalid campaign start time."};const n=e.endAt?Date.parse(String(e.endAt)):NaN;if(e.endAt&&Number.isNaN(n))return{ok:!1,error:"Invalid campaign end time."};if(e.endAt&&n<=s)return{ok:!1,error:"End time must be after start time."};const l=Math.max(1,Math.min(1440,Number(e.cadenceMinutes||60))),m=Math.max(1,Math.min(60,Number(e.postDurationMinutes||10))),c=e.status||"draft",{error:p}=await t.from("fan_feed_trivia_campaigns").insert({title:r,status:c,question_ids:a,schedule_timezone:"UTC",start_at:new Date(s).toISOString(),end_at:e.endAt?new Date(n).toISOString():null,cadence_minutes:l,post_duration_minutes:m,next_run_at:new Date(s).toISOString(),look_and_feel:ee(e.lookAndFeel),created_by:o.id,updated_by:o.id});return p?{ok:!1,error:p.message}:{ok:!0,created:!0}},qr=async e=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in required."};const r={updated_at:g(),updated_by:o.id};if(e.status&&(r.status=e.status),e.title!==void 0&&(r.title=String(e.title||"").trim()),e.questionIds&&(r.question_ids=Array.from(new Set(e.questionIds.map(s=>Number(s)).filter(Number.isFinite)))),e.startAt){const s=Date.parse(String(e.startAt));if(Number.isNaN(s))return{ok:!1,error:"Invalid start time."};r.start_at=new Date(s).toISOString()}if(e.endAt!==void 0)if(!e.endAt)r.end_at=null;else{const s=Date.parse(String(e.endAt));if(Number.isNaN(s))return{ok:!1,error:"Invalid end time."};r.end_at=new Date(s).toISOString()}if(e.cadenceMinutes!==void 0&&(r.cadence_minutes=Math.max(1,Math.min(1440,Number(e.cadenceMinutes||60)))),e.postDurationMinutes!==void 0&&(r.post_duration_minutes=Math.max(1,Math.min(60,Number(e.postDurationMinutes||10)))),e.nextRunAt){const s=Date.parse(String(e.nextRunAt));if(Number.isNaN(s))return{ok:!1,error:"Invalid next run time."};r.next_run_at=new Date(s).toISOString()}e.lookAndFeel&&(r.look_and_feel=ee(e.lookAndFeel));const{error:a}=await t.from("fan_feed_trivia_campaigns").update(r).eq("id",e.id);return a?{ok:!1,error:a.message}:{ok:!0,updated:!0}},Nr=async(e=8)=>{if(!u)return{ok:!1,error:"Trivia requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const{data:o,error:r}=await t.rpc("run_due_trivia_campaigns",{max_posts:Math.max(1,Math.min(50,Number(e||8)))});return r?{ok:!1,error:r.message}:{ok:!0,posted:Number(o||0)}},Ar=e=>{if(!u)return null;const t=d();if(!t)return null;const o=t.channel("fan-feed-realtime").on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_posts"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_comments"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_likes"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_polls"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_poll_options"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_poll_votes"},e).on("postgres_changes",{event:"*",schema:"public",table:"fan_feed_trivia_posts"},e).subscribe();return()=>{t.removeChannel(o)}},Er=async e=>{if(!u)return{ok:!1,error:"Photo upload requires Supabase cloud mode."};const t=d();if(!t)return{ok:!1,error:"Vault is not configured."};const o=await f();if(!o)return{ok:!1,error:"Log in to Fan Vault to upload photos."};if(!e||!e.type.startsWith("image/"))return{ok:!1,error:"Please choose an image file."};if(!de.has(e.type))return{ok:!1,error:"Unsupported image format. Use JPG, PNG, WEBP, GIF, or AVIF."};if(e.size>ve)return{ok:!1,error:"Image is too large. Max 15MB."};const r=new Uint8Array(await e.slice(0,32).arrayBuffer()),a=$e(r);if(!a||!de.has(a))return{ok:!1,error:"Image content did not pass validation."};if(e.type!==a)return{ok:!1,error:"File type mismatch detected. Re-export and upload again."};const s=Ke[a]||"jpg",n=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,l=`${o.id}/${n}.${s}`,{error:m}=await t.storage.from(oe).upload(l,e,{cacheControl:"3600",upsert:!1,contentType:a});if(m)return{ok:!1,error:m.message};const{data:c}=t.storage.from(oe).getPublicUrl(l);return{ok:!0,url:c.publicUrl}};export{Ze as A,rr as B,nr as C,De as D,Ar as E,Er as F,fr as G,kr as H,mr as I,_r as J,hr as K,wr as L,pr as M,gr as N,cr as O,tr as P,or as Q,dr as a,xr as b,Mr as c,Ir as d,qr as e,Cr as f,yr as g,V as h,lr as i,u as j,er as k,Sr as l,br as m,Ye as n,he as o,Qe as p,ar as q,Nr as r,ur as s,sr as t,vr as u,Xe as v,Te as w,ir as x,He as y,We as z};
