import{c as R}from"./index.BtUICepX.js";const O=5,y="https://iahvjkodgrwatcpjdxna.supabase.co",b="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhaHZqa29kZ3J3YXRjcGpkeG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDEwMzAsImV4cCI6MjA4NjI3NzAzMH0.0crxct3Pq52ZhymeTQ05_k8tZdg4KtYaZw92B7d_DKM",q=!!b;let f=null;const n=()=>!q||!y||!b?null:f||(f=R(y,b,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),f),C=()=>{try{return new URL(y).hostname.split(".")[0]||""}catch{return""}},v=e=>Array.isArray(e)?e.filter(t=>typeof t=="string"):[],k=e=>({id:e.id,slug:e.slug,name:e.name,description:e.description||"",product_type:e.product_type,status:e.status,currency:e.currency||"usd",base_price_cents:Number(e.base_price_cents||0),cover_image:e.cover_image||null,gallery:v(e.gallery),related_product_ids:v(e.related_product_ids),metadata:e.metadata||{},created_at:e.created_at,updated_at:e.updated_at}),h=e=>({id:e.id,product_id:e.product_id,sku:e.sku,title:e.title,price_cents:Number(e.price_cents||0),compare_at_cents:e.compare_at_cents==null?null:Number(e.compare_at_cents),inventory_mode:e.inventory_mode==="finite"?"finite":"unlimited",inventory_count:e.inventory_count==null?null:Number(e.inventory_count),weight_grams:e.weight_grams==null?null:Number(e.weight_grams),attributes:e.attributes||{},digital_delivery_url:e.digital_delivery_url||null,stripe_price_id:e.stripe_price_id||null,is_default:!!e.is_default,is_active:!!e.is_active,created_at:e.created_at,updated_at:e.updated_at}),S=e=>({id:Number(e.id),product_id:e.product_id,user_id:e.user_id||null,rating:Number(e.rating||0),title:e.title||"",body:e.body||"",status:e.status,created_at:e.created_at}),x=e=>({id:Number(e.id),user_id:e.user_id||null,stripe_checkout_session_id:e.stripe_checkout_session_id||null,stripe_payment_intent_id:e.stripe_payment_intent_id||null,stripe_customer_email:e.stripe_customer_email||null,status:e.status,currency:e.currency||"usd",subtotal_cents:Number(e.subtotal_cents||0),tax_cents:Number(e.tax_cents||0),shipping_cents:Number(e.shipping_cents||0),total_cents:Number(e.total_cents||0),shipping_carrier:e.shipping_carrier||null,tracking_number:e.tracking_number||null,shipped_at:e.shipped_at||null,fulfilled_at:e.fulfilled_at||null,cancel_reason:e.cancel_reason||null,metadata:e.metadata||{},created_at:e.created_at,updated_at:e.updated_at}),P=e=>({id:Number(e.id),order_id:Number(e.order_id),product_id:e.product_id||null,variant_id:e.variant_id||null,title:e.title,variant_title:e.variant_title||null,sku:e.sku||null,quantity:Number(e.quantity||1),unit_price_cents:Number(e.unit_price_cents||0),line_total_cents:Number(e.line_total_cents||0),delivery_url:e.delivery_url||null}),E=(e,t="usd")=>new Intl.NumberFormat("en-US",{style:"currency",currency:t.toUpperCase(),maximumFractionDigits:2}).format((e||0)/100),j=async()=>{const e=n();if(!e)return null;const{data:t}=await e.auth.getSession();return t.session||null},p=async()=>{const e=n();if(!e)return null;const{data:t}=await e.auth.getUser();return t.user||null},w=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const{error:r}=await t.auth.signInWithOtp({email:e.trim().toLowerCase(),options:{emailRedirectTo:typeof window<"u"?`${window.location.origin}/admin/store`:void 0}});return r?{ok:!1,error:r.message}:{ok:!0,data:{sent:!0}}},B=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r=typeof window<"u"?`${window.location.origin}/admin/store`:void 0,{error:s}=await t.auth.signInWithOAuth({provider:e,options:{redirectTo:r}});return s?{ok:!1,error:s.message}:{ok:!0,data:{redirected:!0}}},J=async()=>{const e=n();e&&await e.auth.signOut()},I=async(e,t,r=!1)=>{const s=C();if(!s)return{ok:!1,error:"Supabase project is not configured."};const i={"Content-Type":"application/json"},o=await j();if(r&&!o?.access_token)return{ok:!1,error:"Please sign in first."};r&&o?.access_token&&(i.Authorization=`Bearer ${o.access_token}`);const c=await fetch(`https://${s}.functions.supabase.co/${e}`,{method:"POST",headers:i,body:JSON.stringify(t)}),d=await c.json().catch(()=>({}));return c.ok?{ok:!0,data:d}:{ok:!1,error:String(d?.error||"Function call failed.")}},L=async()=>{const e=n();if(!e)return{ok:!1,error:"Supabase is not configured."};const{data:t,error:r}=await e.from("store_products").select("*").eq("status","active").order("created_at",{ascending:!1});if(r)return{ok:!1,error:r.message};const s=(t||[]).map(k);if(!s.length)return{ok:!0,data:[]};const i=s.map(a=>a.id),[{data:o},{data:c}]=await Promise.all([e.from("store_product_variants").select("*").in("product_id",i).eq("is_active",!0).order("created_at",{ascending:!0}),e.from("store_reviews").select("*").in("product_id",i).eq("status","approved").order("created_at",{ascending:!1})]),d=(o||[]).map(h),m=(c||[]).map(S),l=new Map;d.forEach(a=>{const u=l.get(a.product_id)||[];u.push(a),l.set(a.product_id,u)});const _=new Map;return m.forEach(a=>{const u=_.get(a.product_id)||[];u.push(a),_.set(a.product_id,u)}),{ok:!0,data:s.map(a=>{const u=l.get(a.id)||[],M=u.find(N=>N.is_default)||u[0]||null;return{...a,variants:u,reviews:_.get(a.id)||[],defaultVariant:M}})}},z=async e=>I("create-store-checkout",e,!0),T=e=>{if(e.inventory_mode!=="finite")return{outOfStock:!1,lowStock:!1,remaining:null};const t=Math.max(0,Number(e.inventory_count||0));return{outOfStock:t<=0,lowStock:t>0&&t<=O,remaining:t}},V=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r=await p();if(!r)return{ok:!1,error:"Please log in to save wishlist items."};const{error:s}=await t.from("store_wishlists").upsert({user_id:r.id,product_id:e});return s?{ok:!1,error:s.message}:{ok:!0,data:{saved:!0}}},W=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r=await p();if(!r)return{ok:!1,error:"Please log in first."};const{error:s}=await t.from("store_wishlists").delete().eq("user_id",r.id).eq("product_id",e);return s?{ok:!1,error:s.message}:{ok:!0,data:{removed:!0}}},Z=async()=>{const e=n();if(!e)return{ok:!1,error:"Supabase is not configured."};const t=await p();if(!t)return{ok:!0,data:[]};const{data:r,error:s}=await e.from("store_wishlists").select("product_id").eq("user_id",t.id);return s?{ok:!1,error:s.message}:{ok:!0,data:(r||[]).map(i=>String(i.product_id))}},U=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r=await p();if(!r)return{ok:!1,error:"Please log in to submit a review."};const{error:s}=await t.from("store_reviews").insert({product_id:e.productId,user_id:r.id,rating:Math.min(5,Math.max(1,Math.round(e.rating))),title:e.title.trim(),body:e.body.trim(),status:"pending"});return s?{ok:!1,error:s.message}:{ok:!0,data:{submitted:!0}}},F=async()=>{const e=n();if(!e)return!1;const t=await p();if(!t)return!1;const{data:r}=await e.from("store_admins").select("role").eq("user_id",t.id).maybeSingle();return!!r?.role},$=async()=>{const e=n();if(!e)return{ok:!1,error:"Supabase is not configured."};const[{data:t,error:r},{data:s,error:i},{data:o,error:c},{data:d,error:m}]=await Promise.all([e.from("store_products").select("*").order("updated_at",{ascending:!1}),e.from("store_product_variants").select("*").order("updated_at",{ascending:!1}),e.from("store_orders").select("*").order("created_at",{ascending:!1}).limit(200),e.from("store_reviews").select("*").order("created_at",{ascending:!1}).limit(200)]);if(r)return{ok:!1,error:r.message};if(i)return{ok:!1,error:i.message};if(c)return{ok:!1,error:c.message};if(m)return{ok:!1,error:m.message};const l=(o||[]).map(x),_=l.map(a=>a.id);let g=[];if(_.length){const{data:a,error:u}=await e.from("store_order_items").select("*").in("order_id",_).order("id",{ascending:!1});if(u)return{ok:!1,error:u.message};g=(a||[]).map(P)}return{ok:!0,data:{products:(t||[]).map(k),variants:(s||[]).map(h),orders:l,orderItems:g,reviews:(d||[]).map(S)}}},D=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r={id:e.id,slug:e.slug.trim().toLowerCase(),name:e.name.trim(),description:e.description||"",product_type:e.product_type,status:e.status||"draft",currency:(e.currency||"usd").toLowerCase(),base_price_cents:Math.max(0,Math.round(e.base_price_cents||0)),cover_image:e.cover_image||null,gallery:e.gallery||[],related_product_ids:e.related_product_ids||[],metadata:e.metadata||{}},s=e.id?t.from("store_products").update(r).eq("id",e.id).select("*").single():t.from("store_products").insert(r).select("*").single(),{data:i,error:o}=await s;return o?{ok:!1,error:o.message}:{ok:!0,data:k(i)}},H=async e=>{const t=n();if(!t)return{ok:!1,error:"Supabase is not configured."};const r={id:e.id,product_id:e.product_id,sku:e.sku.trim(),title:e.title.trim(),price_cents:Math.max(0,Math.round(e.price_cents)),compare_at_cents:e.compare_at_cents==null?null:Math.max(0,Math.round(e.compare_at_cents)),inventory_mode:e.inventory_mode||"unlimited",inventory_count:e.inventory_count==null?null:Math.max(0,Math.round(e.inventory_count)),weight_grams:e.weight_grams==null?null:Math.max(0,Math.round(e.weight_grams)),attributes:e.attributes||{},digital_delivery_url:e.digital_delivery_url||null,stripe_price_id:e.stripe_price_id||null,is_default:!!e.is_default,is_active:e.is_active!==!1,metadata:{}},s=e.id?t.from("store_product_variants").update(r).eq("id",e.id).select("*").single():t.from("store_product_variants").insert(r).select("*").single(),{data:i,error:o}=await s;return o?{ok:!1,error:o.message}:{ok:!0,data:h(i)}},K=async(e,t)=>{const r=n();if(!r)return{ok:!1,error:"Supabase is not configured."};const{error:s}=await r.from("store_reviews").update({status:t}).eq("id",e);return s?{ok:!1,error:s.message}:{ok:!0,data:{updated:!0}}},X=async e=>I("store-admin-action",e,!0);export{O as L,T as a,p as b,w as c,B as d,D as e,E as f,n as g,H as h,F as i,L as j,Z as k,$ as l,W as m,V as n,z as o,U as p,X as r,J as s,K as u};
