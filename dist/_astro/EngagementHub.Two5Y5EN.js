import{j as t}from"./jsx-runtime.TBa3i5EZ.js";import{r}from"./index.CVf8TyFT.js";import{i as ee,j as A,n as te,C as se,D as ae,x as ie}from"./fanVault.BPqpPtzw.js";import"./index.BtUICepX.js";const $="the-performa-engagement-v1",ne="the-performa-badges-v1",L=()=>new Date().toISOString().slice(0,10),B=(i=new Date)=>{const n=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),a=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-a);const y=new Date(Date.UTC(n.getUTCFullYear(),0,1)),h=Math.ceil(((n.getTime()-y.getTime())/864e5+1)/7);return`${n.getUTCFullYear()}-W${String(h).padStart(2,"0")}`},b=()=>({points:120,streak:1,lastSeenDate:L(),dailyClaimDate:"",weekKey:B(),weeklySignal:0,visitedPaths:[],reactions:{fire:0,bolt:0,hands:0},missions:{stageMode:!1,watchAndListen:!1,innerCircle:!1}}),Y=i=>new Date(`${i}T00:00:00`),re=(i,n)=>{const a=Y(n).getTime()-Y(i).getTime();return Math.round(a/864e5)},oe=()=>{if(typeof window>"u")return b();try{const i=localStorage.getItem($);if(!i)return b();const n=JSON.parse(i);return{...b(),...n,reactions:{...b().reactions,...n.reactions??{}},missions:{...b().missions,...n.missions??{}}}}catch{return b()}},I=i=>{localStorage.setItem($,JSON.stringify(i))},v=80,W=[{key:"stageMode",label:"Activate Stage Mode once",reward:v},{key:"watchAndListen",label:"Visit Watch + Listen",reward:v},{key:"innerCircle",label:"Open Inner Circle Access",reward:v}],le=[{name:"Signal Runner",base:980},{name:"Night Architect",base:860},{name:"Vault Operator",base:740}],ce=[{id:"first-signal",label:"First Signal",tier:"core",tip:"Earned by crossing 160 points.",rule:(i,n)=>i.points>=160},{id:"return-runner",label:"Return Runner",tier:"elite",tip:"Earned by maintaining a 3-day streak.",rule:(i,n)=>i.streak>=3},{id:"mission-control",label:"Mission Control",tier:"legend",tip:"Earned by completing all missions.",rule:(i,n)=>n>=3},{id:"crowd-igniter",label:"Crowd Igniter",tier:"elite",tip:"Earned by maxing this week's challenge.",rule:(i,n)=>i.weeklySignal>=220}];function xe(){const[i,n]=r.useState(!1),[a,y]=r.useState(()=>oe()),[h,p]=r.useState(""),[F,K]=r.useState("ember"),[x,_]=r.useState({fire:0,bolt:0,hands:0}),[S,H]=r.useState([]),[j,V]=r.useState(""),g=r.useRef(null),P=r.useRef(a),N=r.useMemo(()=>Object.values(a.missions).filter(Boolean).length,[a.missions]),J=W.length,G=Math.ceil((a.points+1)/200)*200,C=220,R=Math.min(C,a.weeklySignal),z=Math.round(R/C*100),w=r.useMemo(()=>ce.filter(e=>e.rule(a,N)),[a,N]),q=e=>e==="legend"?"badge-tier-legend border-amber-300/60 text-amber-200 bg-amber-500/10":e==="elite"?"badge-tier-elite border-cyan-300/55 text-cyan-200 bg-cyan-500/10":"badge-tier-core border-gold/40 text-gold bg-black/40",Q=r.useMemo(()=>S.length?S.map(e=>({name:e.displayName||"Fan",score:e.score,isYou:!!j&&e.userId===j})):[...le.map(e=>({name:e.name,score:e.base+(a.points*3+a.streak*11)%140,isYou:!1})),{name:"You",score:a.points+a.weeklySignal+a.streak*17,isYou:!0}].sort((e,s)=>s.score-e.score),[S,a.points,a.streak,a.weeklySignal,j]),M=async()=>{if(!A)return;const e=await ie(8);H(e)},O=e=>{P.current=e,A&&(g.current&&window.clearTimeout(g.current),g.current=window.setTimeout(async()=>{await ae(P.current),await M()},320))},u=e=>{y(s=>{const c=e(s);return I(c),O(c),c})},E=e=>{u(s=>s.missions[e]?s:{...s,points:s.points+v,missions:{...s.missions,[e]:!0}})},U=e=>{u(s=>{const c=L(),f=re(s.lastSeenDate,c),k=f===1?s.streak+1:f>1?1:s.streak,m=s.visitedPaths.includes(e)?s.visitedPaths:[...s.visitedPaths,e],D=m.some(d=>d.startsWith("/watch")),o=m.some(d=>d.startsWith("/listen")),l=m.some(d=>d.startsWith("/fan-club"));return{...s,streak:k,lastSeenDate:c,visitedPaths:m,missions:{...s.missions,watchAndListen:s.missions.watchAndListen||D&&o,innerCircle:s.missions.innerCircle||l}}})};r.useEffect(()=>{let e=!1;(async()=>{if(A){const[D,o]=await Promise.all([te(),se()]);e||V(D?.id||""),o&&!e&&(y(l=>{const d={...o,points:Math.max(l.points,o.points),streak:Math.max(l.streak,o.streak),weeklySignal:Math.max(l.weeklySignal,o.weeklySignal),visitedPaths:Array.from(new Set([...o.visitedPaths||[],...l.visitedPaths||[]])),reactions:{fire:Math.max(l.reactions.fire,o.reactions.fire),bolt:Math.max(l.reactions.bolt,o.reactions.bolt),hands:Math.max(l.reactions.hands,o.reactions.hands)},missions:{stageMode:l.missions.stageMode||o.missions.stageMode,watchAndListen:l.missions.watchAndListen||o.missions.watchAndListen,innerCircle:l.missions.innerCircle||o.missions.innerCircle}};return I(d),O(d),d}),await M())}e||U(window.location.pathname)})();const c=()=>U(window.location.pathname);document.addEventListener("astro:after-swap",c);const f=()=>{document.body.dataset.stage==="true"&&E("stageMode")},k=window.__stageMode?.subscribe?.(f);f();const m=ee(()=>{M()});return()=>{e=!0,document.removeEventListener("astro:after-swap",c),k&&k(),m&&m(),g.current&&window.clearTimeout(g.current)}},[]),r.useEffect(()=>{const e=B();a.weekKey!==e&&u(s=>({...s,weekKey:e,weeklySignal:0}))},[a.weekKey]),r.useEffect(()=>{a.missions.watchAndListen&&E("watchAndListen")},[a.missions.watchAndListen]),r.useEffect(()=>{a.missions.innerCircle&&E("innerCircle")},[a.missions.innerCircle]),r.useEffect(()=>{if(!h)return;const e=window.setTimeout(()=>p(""),1600);return()=>window.clearTimeout(e)},[h]),r.useEffect(()=>{const e=JSON.stringify(w);localStorage.setItem(ne,e),window.dispatchEvent(new CustomEvent("performa:badges-updated",{detail:w}))},[w]),r.useEffect(()=>{const e=()=>K(document.body.dataset.stageTheme||"ember");e();const s=new MutationObserver(e);return s.observe(document.body,{attributes:!0,attributeFilter:["data-stage-theme"]}),()=>s.disconnect()},[]);const T=e=>{u(s=>({...s,points:s.points+5,weeklySignal:s.weeklySignal+10,reactions:{...s.reactions,[e]:s.reactions[e]+1}})),_(s=>({...s,[e]:s[e]+1})),p("Reaction sent +5")},X=()=>{const e=L();if(a.dailyClaimDate===e){p("Daily already claimed");return}u(s=>({...s,points:s.points+40,weeklySignal:s.weeklySignal+20,dailyClaimDate:e})),p("Daily check-in +40")},Z=async()=>{const e={title:"Chip Lee - The Performa",text:"Stage Mode is live. Tap in.",url:window.location.href};try{navigator.share?await navigator.share(e):await navigator.clipboard.writeText(window.location.href),u(s=>({...s,points:s.points+15,weeklySignal:s.weeklySignal+15})),p("Share pulse +15")}catch{p("Share cancelled")}};return t.jsxs("aside",{className:"fixed left-4 bottom-4 z-40 w-[min(92vw,360px)] max-h-[calc(100dvh-8rem)] rounded-2xl border bg-black/75 p-3 shadow-[0_12px_42px_rgba(0,0,0,0.58)] backdrop-blur-xl sm:max-h-[calc(100dvh-7rem)]",style:{borderColor:"rgba(var(--accent-rgb), 0.45)",boxShadow:"0 12px 42px rgba(0,0,0,0.58), 0 0 36px rgba(var(--accent-rgb), 0.2)"},"data-theme":F,"aria-label":"Fan engagement hub",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.3em] text-gold/90",children:"Crowd Pulse - Rate Me"}),t.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Points ",a.points," | Streak ",a.streak,"d"]})]}),t.jsx("button",{type:"button",onClick:()=>n(e=>!e),className:"rounded-full border border-white/25 px-3 py-1 text-[10px] uppercase tracking-[0.26em] text-white/80 hover:border-gold/60 hover:text-gold","aria-expanded":i,children:i?"Hide":"Open"})]}),i&&t.jsxs("div",{className:"mt-3 space-y-3 overflow-y-auto pr-1 max-h-[calc(100dvh-13rem)] sm:max-h-[calc(100dvh-12rem)]",children:[t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Crowd Pulse"}),t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>T("fire"),className:"reaction-btn rounded-full border border-white/20 px-3 py-1 text-sm hover:border-gold/60",children:["FIRE ",120+a.reactions.fire,x.fire>0&&t.jsx("span",{className:"reaction-burst reaction-burst-fire","aria-hidden":"true"},x.fire)]}),t.jsxs("button",{type:"button",onClick:()=>T("bolt"),className:"reaction-btn rounded-full border border-white/20 px-3 py-1 text-sm hover:border-gold/60",children:["HYPE ",84+a.reactions.bolt,x.bolt>0&&t.jsx("span",{className:"reaction-burst reaction-burst-hype","aria-hidden":"true"},x.bolt)]}),t.jsxs("button",{type:"button",onClick:()=>T("hands"),className:"reaction-btn rounded-full border border-white/20 px-3 py-1 text-sm hover:border-gold/60",children:["CHEER ",57+a.reactions.hands,x.hands>0&&t.jsx("span",{className:"reaction-burst reaction-burst-cheer","aria-hidden":"true"},x.hands)]})]})]}),t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Daily Ops"}),t.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[t.jsx("button",{type:"button",onClick:X,className:"rounded-full border border-gold/30 px-4 py-2 text-[10px] uppercase tracking-[0.22em] text-gold hover:bg-gold/10",children:"Daily Check-in"}),t.jsx("button",{type:"button",onClick:Z,className:"rounded-full border border-white/25 px-4 py-2 text-[10px] uppercase tracking-[0.22em] text-white/80 hover:border-white/50 hover:text-white",children:"Share Signal"})]}),t.jsxs("p",{className:"mt-2 text-[11px] text-white/55",children:["Next milestone unlock at ",G," points."]})]}),t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Return Missions"}),t.jsx("ul",{className:"mt-2 space-y-2 text-xs text-white/75",children:W.map(e=>t.jsxs("li",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{children:e.label}),t.jsx("span",{className:a.missions[e.key]?"text-gold":"text-white/45",children:a.missions[e.key]?"Complete":`+${e.reward}`})]},e.key))}),t.jsxs("p",{className:"mt-2 text-[11px] text-white/55",children:[N,"/",J," missions completed"]})]}),t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Weekly Challenge"}),t.jsx("p",{className:"mt-2 text-xs text-white/75",children:"Push the crowd meter to 100% this week."}),t.jsx("div",{className:"mt-2 h-2 overflow-hidden rounded-full bg-white/10",children:t.jsx("div",{className:"h-full rounded-full transition-[width] duration-500",style:{width:`${z}%`,background:"linear-gradient(90deg, rgba(var(--accent-rgb),0.55), rgba(var(--accent-rgb),1))"}})}),t.jsxs("p",{className:"mt-2 text-[11px] text-white/55",children:[R,"/",C," signal points"]}),t.jsx("p",{className:"mt-1 text-[11px] text-white/45",children:"Weekly reset: Monday 12:00 AM local"})]}),t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Community Heat"}),t.jsx("ul",{className:"mt-2 space-y-2 text-xs text-white/75",children:Q.map((e,s)=>t.jsxs("li",{className:"flex items-center justify-between gap-3",children:[t.jsxs("span",{children:["#",s+1," ",e.name]}),t.jsx("span",{className:e.isYou?"text-gold":"text-white/60",children:e.score})]},e.name))})]}),t.jsxs("div",{className:"rounded-xl border border-white/15 bg-black/70 p-3",children:[t.jsx("p",{className:"text-[10px] uppercase tracking-[0.26em] text-white/55",children:"Unlocked Badges"}),t.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:w.length>0?w.map(e=>t.jsxs("span",{title:`${e.label} (${e.tier.toUpperCase()}): ${e.tip}`,className:`rounded-full border px-3 py-1 text-[10px] uppercase tracking-[0.2em] ${q(e.tier)}`,children:[e.label," Â· ",e.tier]},e.id)):t.jsx("span",{className:"text-xs text-white/50",children:"No badges unlocked yet."})})]})]}),h&&t.jsx("p",{className:"mt-3 text-xs text-gold",children:h})]})}export{xe as default};
