import{j as e}from"./jsx-runtime.TBa3i5EZ.js";import{r as a}from"./index.CVf8TyFT.js";import{e as p,s as ue,p as E,i as x,f as ge,g as he,h as se,j as be,k as fe,m as we,n as Ne,o as je,q as ke,t as ye,v as ve,w as ae}from"./fanVault.BDzHPXqn.js";import"./index.BtUICepX.js";const re={google:{label:"Google",icon:"G"},apple:{label:"Apple",icon:"A"},facebook:{label:"Facebook",icon:"f"},github:{label:"GitHub",icon:"GH"}},Se="the-performa-engagement-v1",Ce="the-performa-live-dispatch-logs-v1";function Ie(){const[u,B]=a.useState("register"),[D,R]=a.useState(""),[L,_]=a.useState(""),[A,V]=a.useState(""),[$,j]=a.useState(""),[q,k]=a.useState(p),[g,i]=a.useState(""),[le,W]=a.useState(!0),[y,v]=a.useState(!1),[G,T]=a.useState(!1),[H,Y]=a.useState(""),[J,I]=a.useState(!1),[l,ie]=a.useState(null),[h,K]=a.useState([]),[Q,z]=a.useState([]),[X,Z]=a.useState(p),[b,P]=a.useState({points:0,streak:0,weeklySignal:0}),[O,oe]=a.useState([]),[f,S]=a.useState([]),[ee,F]=a.useState(""),ne=a.useMemo(()=>"".split(",").map(t=>t.trim().toLowerCase()).filter(Boolean),[]),m=async()=>{const t=await he();if(ie(t),!t){K([]),z([]),j(""),k(p);return}x&&await se(t.id);const[s,r]=await Promise.all([be(),fe()]);K(s),z(r),j(t.bio||""),k(t.profileBadgeId||p),Z(t.profileBadgeId||p)};a.useEffect(()=>{(async()=>{if(W(!0),x){const o=await we();o.ok||i(o.error)}await m(),W(!1)})();const s=()=>{m()},r=()=>{if(x){se().then(()=>m());return}m()};return window.addEventListener("fanvault:changed",s),window.addEventListener("performa:badges-updated",r),()=>{window.removeEventListener("fanvault:changed",s),window.removeEventListener("performa:badges-updated",r)}},[]);const M=!!(l?.email&&ne.includes(l.email.toLowerCase()));a.useEffect(()=>{const t=async()=>{if(x){const[r,o]=await Promise.all([Ne(),je(10)]);P({points:Number(r?.points||0),streak:Number(r?.streak||0),weeklySignal:Number(r?.weeklySignal||0)}),oe(o)}else try{const r=JSON.parse(localStorage.getItem(Se)||"{}");P({points:Number(r.points||0),streak:Number(r.streak||0),weeklySignal:Number(r.weeklySignal||0)})}catch{P({points:0,streak:0,weeklySignal:0})}try{const r=localStorage.getItem("the-performa-operator-token-v1")||"",o="https://iahvjkodgrwatcpjdxna.supabase.co",n=o?new URL(o).hostname.split(".")[0]:"";if(r&&n&&M){const c=await fetch(`https://${n}.functions.supabase.co/go-live-blast`,{headers:{Authorization:`Bearer ${r}`}}),C=await c.json().catch(()=>({}));if(c.ok&&Array.isArray(C.rows)){S(C.rows.map(d=>({id:String(d.id),createdAt:d.created_at,status:d.status,title:d.title,streamUrl:d.stream_url,platform:d.platform,emailSent:Number(d.email_count||0),smsSent:Number(d.sms_count||0),opens:Number(d.opens||0),clicks:Number(d.clicks||0)}))),F("");return}F(C?.error?String(C.error):"Unable to load cloud dispatch metrics.")}}catch{F("Unable to load cloud dispatch metrics.")}try{const r=JSON.parse(localStorage.getItem(Ce)||"[]");Array.isArray(r)?S(r.slice(0,20)):S([])}catch{S([])}};t(),window.addEventListener("performa:dispatch-log",t),window.addEventListener("storage",t),window.addEventListener("astro:after-swap",t);const s=ue(()=>{t()});return()=>{window.removeEventListener("performa:dispatch-log",t),window.removeEventListener("storage",t),window.removeEventListener("astro:after-swap",t),s&&s()}},[M]),a.useEffect(()=>{if(!g)return;const t=window.setTimeout(()=>i(""),2200);return()=>window.clearTimeout(t)},[g]);const w=a.useMemo(()=>({gallery:h.filter(t=>t.type==="gallery"),watch:h.filter(t=>t.type==="watch"),listen:h.filter(t=>t.type==="listen")}),[h]),te=a.useMemo(()=>E.find(t=>t.id===(l?.profileBadgeId||p))||E[0],[l]),U=a.useMemo(()=>{const t=(l?.bio||"").trim().length>=20,s=h.length>0,r=!!(l?.profileBadgeId&&l.profileBadgeId!==p);return{completed:[t,s,r].filter(Boolean).length,total:3,steps:[{label:"Add a profile bio (20+ chars)",done:t},{label:"Save at least one favorite",done:s},{label:"Pick a custom profile badge",done:r}]}},[h.length,l?.bio,l?.profileBadgeId]),ce=a.useMemo(()=>{if(O.length)return O.slice(0,5).map(r=>({name:r.displayName||"Fan",score:r.score}));const t=[{name:"Signal Runner",score:1140},{name:"Night Architect",score:980},{name:"Vault Operator",score:865}],s=b.points+b.weeklySignal+b.streak*14;return[...t,{name:l?.name||"You",score:s}].sort((r,o)=>o.score-r.score).slice(0,5)},[b.points,b.streak,b.weeklySignal,O,l?.name]),N=a.useMemo(()=>{const t=f.reduce((n,c)=>n+Number(c.emailSent||0),0),s=f.reduce((n,c)=>n+Number(c.smsSent||0),0),r=f.reduce((n,c)=>n+Number(c.opens||0),0),o=f.reduce((n,c)=>n+Number(c.clicks||0),0);return{email:t,sms:s,opens:r,clicks:o,count:f.length}},[f]),de=async t=>{t.preventDefault(),v(!0);const s=u==="register"?await ke(D,L,A):await ye(L,A);if(v(!1),!s.ok){i(s.error);return}"requiresConfirm"in s&&s.requiresConfirm?(i("Account created. Check your email to confirm, then log in."),B("login")):i(u==="register"?"Fan Vault created.":"Welcome back."),R(""),_(""),V(""),await m()},me=async t=>{Y(t);const s=await ve(t);if(!s.ok){i(s.error),Y("");return}i(`Redirecting to ${t}...`)},pe=async()=>{v(!0);const t=await ae({bio:$,profileBadgeId:q});if(v(!1),!t){i("Please log in first.");return}i("Profile updated."),I(!1),await m()},xe=async()=>{T(!0);const t=await ae({profileBadgeId:X});if(T(!1),!t){i("Unable to update badge.");return}i("Badge updated."),await m()};return le?e.jsx("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:e.jsx("p",{className:"text-sm text-white/70",children:"Loading Fan Vault..."})}):l?e.jsxs("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-1 h-11 w-11 rounded-xl border border-gold/40 bg-black/40 p-2 text-gold",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:te.svg}})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.34em] text-gold/85",children:"Fan Vault Profile"}),e.jsx("h3",{className:"mt-2 font-display text-3xl",children:l.name}),e.jsx("p",{className:"mt-2 text-sm text-white/70",children:l.email}),e.jsxs("p",{className:"mt-1 text-xs text-white/45",children:["Mode: ",x?"Cloud Sync":"Local Device"]}),e.jsxs("p",{className:"mt-1 text-xs text-gold/80",children:["Badge: ",te.label]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("select",{value:X,onChange:t=>Z(t.target.value),className:"rounded-full border border-white/20 bg-black/40 px-3 py-1 text-[11px] text-white/80",style:{color:"#f5f5f7",backgroundColor:"#111318"},children:E.map(t=>e.jsx("option",{value:t.id,style:{color:"#0f1116",backgroundColor:"#ffffff"},children:t.label},t.id))}),e.jsx("button",{type:"button",onClick:xe,disabled:G,className:"rounded-full border border-gold/40 px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-gold min-h-10 disabled:opacity-60",children:G?"Saving":"Apply"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>I(t=>!t),className:"rounded-full border border-gold/40 px-5 py-2 text-xs uppercase tracking-[0.25em] text-gold min-h-11",children:J?"Close Edit":"Edit Profile"}),e.jsx("button",{type:"button",onClick:async()=>{await ge(),i("Signed out."),await m()},className:"rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.25em] text-white/75 min-h-11",children:"Sign Out"})]})]}),J&&e.jsxs("div",{className:"mt-6 rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Edit Profile Configuration"}),e.jsx("textarea",{value:$,onChange:t=>j(t.target.value),rows:3,className:"mt-3 w-full rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40",placeholder:"Add a short fan bio..."}),e.jsx("p",{className:"mt-4 text-xs uppercase tracking-[0.28em] text-white/55",children:"Profile Badge"}),e.jsx("div",{className:"mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3",children:E.map(t=>{const s=q===t.id;return e.jsxs("button",{type:"button",onClick:()=>k(t.id),className:`rounded-2xl border p-3 text-left transition ${s?"border-gold/60 bg-gold/10":"border-white/15 bg-black/40 hover:border-gold/35"}`,children:[e.jsx("div",{className:"mb-2 h-10 w-10 text-gold",dangerouslySetInnerHTML:{__html:t.svg}}),e.jsx("p",{className:"text-xs uppercase tracking-[0.22em] text-white/80",children:t.label}),e.jsx("p",{className:"mt-1 text-[11px] text-white/55",children:t.description}),e.jsx("p",{className:"mt-2 text-[10px] uppercase tracking-[0.2em] text-gold/85",children:t.tier})]},t.id)})}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{type:"button",disabled:y,onClick:pe,className:"rounded-full border border-gold/40 px-5 py-2 text-xs uppercase tracking-[0.25em] text-gold disabled:opacity-60",children:y?"Saving...":"Save Profile"}),e.jsx("button",{type:"button",onClick:()=>{j(l.bio||""),k(l.profileBadgeId||p),I(!1)},className:"rounded-full border border-white/30 px-5 py-2 text-xs uppercase tracking-[0.25em] text-white/75",children:"Cancel"})]})]}),e.jsxs("div",{className:"mt-8 grid gap-4 md:grid-cols-2",children:[e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Collected Badges"}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:Q.length?Q.map(t=>e.jsx("span",{className:"rounded-full border border-gold/45 px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-gold",children:t.label},t.id)):e.jsx("p",{className:"text-sm text-white/55",children:"No badges yet."})})]}),e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Saved Favorites"}),e.jsxs("p",{className:"mt-3 text-sm text-white/70",children:["Gallery ",w.gallery.length," | Watch ",w.watch.length," | Listen ",w.listen.length]})]})]}),e.jsxs("div",{className:"mt-8 grid gap-4 md:grid-cols-3",children:[e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Onboarding Missions"}),e.jsxs("p",{className:"mt-2 text-sm text-white/70",children:[U.completed,"/",U.total," complete"]}),e.jsx("ul",{className:"mt-3 space-y-2 text-xs text-white/75",children:U.steps.map(t=>e.jsxs("li",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{children:t.label}),e.jsx("span",{className:t.done?"text-gold":"text-white/45",children:t.done?"Done":"Pending"})]},t.label))})]}),e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Weekly Leaderboard"}),e.jsx("ul",{className:"mt-3 space-y-2 text-xs text-white/75",children:ce.map((t,s)=>e.jsxs("li",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{children:["#",s+1," ",t.name]}),e.jsx("span",{className:t.name===(l?.name||"You")?"text-gold":"text-white/60",children:t.score})]},`${t.name}-${s}`))})]}),M&&e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:"Performance Health"}),e.jsxs("p",{className:"mt-2 text-xs text-white/70",children:["Dispatches: ",N.count]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Emails sent: ",N.email]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["SMS sent: ",N.sms]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Opens tracked: ",N.opens]}),e.jsxs("p",{className:"mt-1 text-xs text-white/70",children:["Clicks tracked: ",N.clicks]}),ee&&e.jsx("p",{className:"mt-2 text-[11px] text-gold",children:ee})]})]}),e.jsx("div",{className:"mt-8 grid gap-4 md:grid-cols-3",children:["gallery","watch","listen"].map(t=>e.jsxs("article",{className:"rounded-2xl border border-white/15 bg-black/45 p-4",children:[e.jsxs("p",{className:"text-xs uppercase tracking-[0.28em] text-white/55",children:[t," Favorites"]}),e.jsxs("ul",{className:"mt-3 space-y-2 text-sm text-white/75",children:[w[t].slice(0,5).map(s=>e.jsx("li",{children:e.jsx("a",{href:s.href,className:"hover:text-gold",children:s.title})},`${s.type}-${s.id}`)),!w[t].length&&e.jsx("li",{className:"text-white/45",children:"None saved yet."})]})]},t))}),g&&e.jsx("p",{className:"mt-4 text-xs text-gold",children:g})]}):e.jsxs("div",{className:"rounded-[2rem] border border-white/15 bg-black/55 p-6 backdrop-blur-md",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.34em] text-gold/85",children:"Fan Vault"}),e.jsx("h3",{className:"mt-2 font-display text-2xl",children:"Register or Log In"}),e.jsx("p",{className:"mt-2 text-sm text-white/70",children:x?"Create a cloud profile to sync favorites and badges across devices.":"Create a local profile on this device. Add Supabase keys to enable cloud sync."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>B("register"),className:`rounded-full border px-4 py-2 text-xs uppercase tracking-[0.25em] min-h-11 ${u==="register"?"border-gold/60 text-gold":"border-white/20 text-white/70"}`,children:"Register"}),e.jsx("button",{type:"button",onClick:()=>B("login"),className:`rounded-full border px-4 py-2 text-xs uppercase tracking-[0.25em] min-h-11 ${u==="login"?"border-gold/60 text-gold":"border-white/20 text-white/70"}`,children:"Log In"})]})]}),e.jsxs("form",{className:"mt-6 grid gap-4 md:grid-cols-2",onSubmit:de,children:[u==="register"&&e.jsx("input",{value:D,onChange:t=>R(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Display Name",required:!0}),e.jsx("input",{value:L,onChange:t=>_(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Email",required:!0}),e.jsx("input",{value:A,onChange:t=>V(t.target.value),className:"rounded-2xl border border-white/20 bg-black/40 px-4 py-3 text-white placeholder:text-white/40 min-h-11",placeholder:"Password",type:"password",required:!0}),e.jsx("button",{type:"submit",disabled:y,className:"rounded-full bg-ember px-6 py-3 text-xs uppercase tracking-[0.3em] text-ink min-h-11 disabled:opacity-60",children:y?"Working...":u==="register"?"Create Fan Vault":"Enter Vault"})]}),x&&e.jsxs("div",{className:"mt-5",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.24em] text-white/55",children:"Or continue with"}),e.jsx("div",{className:"mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:["google","apple","facebook","github"].map(t=>e.jsxs("button",{type:"button",onClick:()=>me(t),disabled:!!H,className:"inline-flex min-h-11 items-center justify-center gap-2 rounded-full border border-white/25 bg-black/35 px-4 py-2 text-[11px] uppercase tracking-[0.22em] text-white/80 hover:border-gold/50 hover:text-gold disabled:opacity-60",children:[e.jsx("span",{className:"inline-flex h-4 w-4 items-center justify-center rounded-full border border-white/30 text-[9px] leading-none",children:re[t].icon}),e.jsx("span",{children:H===t?"Working...":re[t].label})]},t))})]}),g&&e.jsx("p",{className:"mt-3 text-xs text-gold",children:g}),e.jsxs("p",{className:"mt-3 text-xs text-white/45",children:["Mode: ",x?"Cloud Sync (Supabase)":"Local Device Only"]})]})}export{Ie as default};
