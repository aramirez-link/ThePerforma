---
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "";
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || "";

const primaryLinks = [
  { label: "Stage", href: "/" },
  { label: "Watch", href: "/watch" },
  { label: "Listen", href: "/listen" },
  { label: "Link Up", href: "/feed" }
];

const toolkitLinks = [
  { label: "Store", href: "/store" },
  { label: "Fan Vault", href: "/fan-club" },
  { label: "Story", href: "/story" },
  { label: "Live", href: "/live" },
  { label: "Gallery", href: "/gallery" },
  { label: "Moderation", href: "/admin/moderation", adminOnly: true },
  { label: "Trivia", href: "/admin/trivia", adminOnly: true }
];

---
<nav class="sticky top-0 z-50 w-full" aria-label="Primary">
  <div class="mx-auto w-full max-w-6xl px-3 pt-3 sm:px-4 sm:pt-4">
    <div class="flex items-center justify-between gap-2 rounded-full border border-white/15 bg-black/45 px-3 py-3 backdrop-blur-xl shadow-[0_10px_40px_rgba(0,0,0,0.35)] md:gap-3 md:px-5">
      <a href="/" data-internal-nav class="inline-flex items-center gap-2">
        <img src="/assets/img/CHIPLEE_LOGO_Clear.png" alt="The Performa logo" class="h-9 w-auto md:h-10" />
        <span class="hidden text-sm font-semibold uppercase tracking-[0.2em] text-white/90 sm:inline">The Performa</span>
        <span
          id="nav-live-ribbon"
          class="hidden rounded-full border border-ember/70 bg-ember/20 px-2 py-1 text-[9px] uppercase tracking-[0.2em] text-gold"
        >
          Live Now
        </span>
      </a>

      <div class="hidden items-center gap-6 text-xs uppercase tracking-[0.24em] lg:flex">
        {primaryLinks.map((link) => (
          <a href={link.href} data-internal-nav class="text-white/70 transition hover:text-white">
            {link.label}
          </a>
        ))}

        <div class="group relative">
          <button
            type="button"
            aria-controls="toolkit-panel"
            aria-expanded="false"
            data-toolkit-toggle
            class="text-white/70 transition hover:text-white group-hover:text-white"
          >
            TOOLKIT
          </button>
          <div id="toolkit-panel" class="toolkit-panel invisible absolute left-1/2 top-8 z-10 w-44 -translate-x-1/2 rounded-xl border border-white/15 bg-black/90 p-2 opacity-0 backdrop-blur-xl transition duration-150 group-hover:visible group-hover:opacity-100 group-focus-within:visible group-focus-within:opacity-100">
            {toolkitLinks.map((link) => (
              <a href={link.href} data-internal-nav data-admin-only={link.adminOnly ? "true" : "false"} class={`block rounded-lg px-3 py-2 text-[10px] uppercase tracking-[0.24em] text-white/75 transition hover:bg-white/10 hover:text-white ${link.adminOnly ? "hidden" : ""}`}>
                {link.label}
              </a>
            ))}
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 md:gap-3">
        <a
          href="/book"
          data-internal-nav
          class="hidden rounded-full bg-ember px-4 py-2 text-[10px] uppercase tracking-[0.28em] text-ink shadow-[0_0_25px_rgba(242,84,45,0.35)] transition hover:shadow-[0_0_35px_rgba(242,84,45,0.5)] sm:inline-flex"
        >
          Create your Experience
        </a>
        <a
          href="/fan-club"
          data-internal-nav
          data-fan-auth-button
          class="rounded-full border border-white/25 px-4 py-2 text-[10px] uppercase tracking-[0.28em] text-white/80 transition hover:border-white/50 hover:text-white min-h-11 inline-flex items-center"
          aria-label="Log in to Fan Vault"
        >
          Login
        </a>
      </div>
    </div>
  </div>
</nav>
<script define:vars={{ supabaseUrl, supabaseAnonKey }}>
  import { createClient } from "@supabase/supabase-js";
  import { getCurrentUser, logoutUser } from "../lib/fanVault";

  (() => {
    if (window.__performaNavBound) return;
    window.__performaNavBound = true;

    const isInternal = (href) => {
      if (!href) return false;
      if (href.startsWith("#")) return false;
      if (href.startsWith("mailto:") || href.startsWith("tel:")) return false;
      if (href.startsWith("http://") || href.startsWith("https://")) {
        try {
          return new URL(href, window.location.origin).origin === window.location.origin;
        } catch {
          return false;
        }
      }
      return href.startsWith("/");
    };

    document.addEventListener("click", async (event) => {
      const rawTarget = event.target;
      const targetElement =
        rawTarget instanceof Element
          ? rawTarget
          : rawTarget instanceof Node
            ? rawTarget.parentElement
            : null;
      const link = targetElement ? targetElement.closest("a[data-internal-nav]") : null;
      if (!link) return;
      if (link.hasAttribute("data-fan-auth-button")) return;
      const details = link.closest("details");
      if (details && details.hasAttribute("open")) {
        details.removeAttribute("open");
      }

      const href = link.getAttribute("href");
      if (!isInternal(href)) return;
      if (event.defaultPrevented) return;
      if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
      if (link.target && link.target !== "_self") return;

      event.preventDefault();
      try {
        const { navigate } = await import("astro:transitions/client");
        navigate(href);
      } catch {
        window.location.assign(href);
      }
    });

    const toolkitToggle = document.querySelector("[data-toolkit-toggle]");
    const toolkitPanel = document.getElementById("toolkit-panel");
    let supabaseClient = null;
    let fanAuthBound = false;
    let fanLoggedIn = false;
    let fanAuthSub = null;
    const closeToolkit = () => {
      if (!toolkitToggle || !toolkitPanel) return;
      toolkitToggle.setAttribute("aria-expanded", "false");
      toolkitPanel.classList.remove("is-open");
    };

    const toggleToolkit = (forceOpen) => {
      if (!toolkitToggle || !toolkitPanel) return;
      const open = typeof forceOpen === "boolean" ? forceOpen : !toolkitPanel.classList.contains("is-open");
      toolkitPanel.classList.toggle("is-open", open);
      toolkitToggle.setAttribute("aria-expanded", open ? "true" : "false");
    };

    if (toolkitToggle && toolkitPanel) {
      toolkitToggle.addEventListener("click", (event) => {
        event.preventDefault();
        toggleToolkit();
      });
    }

    document.addEventListener("click", (event) => {
      if (toolkitToggle && toolkitPanel) {
        const clickedToggle = toolkitToggle.contains(event.target);
        const clickedPanel = toolkitPanel.contains(event.target);
        if (!clickedToggle && !clickedPanel) closeToolkit();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape") return;
      closeToolkit();
    });

    const LIVE_STATUS_KEY = "the-performa-live-status-v1";
    const ADMIN_NAV_KEY = "the-performa-admin-nav";
    const SUPABASE_URL = supabaseUrl || "";
    const SUPABASE_ANON_KEY = supabaseAnonKey || "";
    const ribbon = document.getElementById("nav-live-ribbon");
    const syncLiveRibbon = () => {
      if (!ribbon) return;
      try {
        const raw = localStorage.getItem(LIVE_STATUS_KEY);
        const data = raw ? JSON.parse(raw) : null;
        const isLive = Boolean(data && data.status === "live");
        ribbon.classList.toggle("hidden", !isLive);
      } catch {
        ribbon.classList.add("hidden");
      }
    };

    window.addEventListener("storage", (event) => {
      if (event.key === LIVE_STATUS_KEY) syncLiveRibbon();
    });
    window.addEventListener("performa:live-status", syncLiveRibbon);
    document.addEventListener("astro:after-swap", syncLiveRibbon);
    syncLiveRibbon();

    const syncAdminLinks = () => {
      const isAdmin = localStorage.getItem(ADMIN_NAV_KEY) === "true";
      const adminLinks = Array.from(document.querySelectorAll("[data-admin-only='true']"));
      adminLinks.forEach((node) => {
        node.classList.toggle("hidden", !isAdmin);
      });
    };

    const syncAuthButtonLabel = () => {
      const buttons = Array.from(document.querySelectorAll("[data-fan-auth-button]"));
      buttons.forEach((button) => {
        button.textContent = fanLoggedIn ? "Log out" : "Login";
        button.setAttribute("aria-label", fanLoggedIn ? "Log out of Fan Vault" : "Log in to Fan Vault");
      });
    };

    const getPersistedFanLoginState = () => {
      const hasSupabaseTokenInStorage = (storage) => {
        if (!storage) return false;
        for (let i = 0; i < storage.length; i += 1) {
          const key = storage.key(i);
          if (!key) continue;
          const isModernSupabaseKey = key.startsWith("sb-") && key.endsWith("-auth-token");
          const isLegacySupabaseKey = key === "supabase.auth.token";
          if (!isModernSupabaseKey && !isLegacySupabaseKey) continue;
          const raw = storage.getItem(key);
          if (!raw) continue;
          try {
            const parsed = JSON.parse(raw);
            if (parsed?.access_token || parsed?.currentSession?.access_token) return true;
          } catch {
            if (typeof raw === "string" && raw.includes("access_token")) return true;
          }
        }
        return false;
      };

      try {
        const localVaultSession = localStorage.getItem("the-performa-fan-vault-session-v1");
        if (localVaultSession) return true;
      } catch {
        // continue to other stores
      }
      try {
        if (hasSupabaseTokenInStorage(localStorage)) return true;
      } catch {}
      try {
        if (hasSupabaseTokenInStorage(sessionStorage)) return true;
      } catch {}
      return false;
    };

    const getSupabaseClient = async () => {
      if (supabaseClient) return supabaseClient;
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
      return supabaseClient;
    };

    const syncAdminFlagFromSupabase = async () => {
      let supabase = null;
      try {
        supabase = await getSupabaseClient();
      } catch {
        fanLoggedIn = getPersistedFanLoginState();
        syncAuthButtonLabel();
        syncAdminLinks();
        return;
      }
      if (!supabase) {
        localStorage.removeItem(ADMIN_NAV_KEY);
        fanLoggedIn = getPersistedFanLoginState();
        syncAuthButtonLabel();
        syncAdminLinks();
        return;
      }
      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const user = sessionData?.session?.user || null;
        if (!user) {
          localStorage.removeItem(ADMIN_NAV_KEY);
          try {
            const currentUser = await getCurrentUser();
            fanLoggedIn = Boolean(currentUser);
          } catch {
            fanLoggedIn = false;
          }
          syncAuthButtonLabel();
          syncAdminLinks();
          return;
        }
        fanLoggedIn = true;
        syncAuthButtonLabel();
        const { data } = await supabase.from("store_admins").select("role").eq("user_id", user.id).maybeSingle();
        if (data?.role) localStorage.setItem(ADMIN_NAV_KEY, "true");
        else localStorage.removeItem(ADMIN_NAV_KEY);
      } catch {
        fanLoggedIn = getPersistedFanLoginState();
        syncAuthButtonLabel();
      }
      syncAdminLinks();
    };

    const bindAuthButton = async () => {
      if (fanAuthBound) return;
      fanAuthBound = true;
      document.addEventListener("click", async (event) => {
        const targetNode = event.target;
        const targetElement =
          targetNode instanceof Element
            ? targetNode
            : targetNode instanceof Node
              ? targetNode.parentElement
              : null;
        const trigger = targetElement ? targetElement.closest("[data-fan-auth-button]") : null;
        if (!trigger) return;
        if (!fanLoggedIn) {
          return;
        }
        event.preventDefault();
        await logoutUser();
        localStorage.removeItem(ADMIN_NAV_KEY);
        fanLoggedIn = false;
        syncAuthButtonLabel();
        syncAdminLinks();
        window.location.assign("/fan-club");
      });
    };

    const bindAuthState = async () => {
      let supabase = null;
      try {
        supabase = await getSupabaseClient();
      } catch {
        return;
      }
      if (!supabase || fanAuthSub) return;
      fanAuthSub = supabase.auth.onAuthStateChange(() => {
        void syncAdminFlagFromSupabase();
      });
    };

    window.addEventListener("storage", (event) => {
      if (event.key === ADMIN_NAV_KEY) syncAdminLinks();
      if (
        event.key === "the-performa-fan-vault-session-v1" ||
        (typeof event.key === "string" && event.key.startsWith("sb-") && event.key.endsWith("-auth-token"))
      ) {
        fanLoggedIn = getPersistedFanLoginState();
        syncAuthButtonLabel();
      }
    });
    window.addEventListener("fanvault:changed", () => {
      fanLoggedIn = getPersistedFanLoginState();
      syncAuthButtonLabel();
      void syncAdminFlagFromSupabase();
    });
    window.addEventListener("focus", () => {
      void syncAdminFlagFromSupabase();
    });
    document.addEventListener("astro:after-swap", () => {
      void syncAdminFlagFromSupabase();
    });
    window.setInterval(() => {
      void syncAdminFlagFromSupabase();
    }, 2000);
    void bindAuthButton();
    void bindAuthState();
    fanLoggedIn = getPersistedFanLoginState();
    syncAuthButtonLabel();
    void syncAdminFlagFromSupabase();
    syncAdminLinks();
  })();
</script>
