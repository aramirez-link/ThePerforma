---
import listen from "../../content/listen.json";

const soundcloudItem = listen.find((item) => item.platform.toLowerCase() === "soundcloud");
const soundcloudEmbedUrl =
  soundcloudItem?.embedUrl ??
  "https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/chipleetheperforma";
---

<aside
  id="global-mini-player"
  transition:name="global-mini-player"
  transition:persist
  class="fixed bottom-4 right-4 z-[70] w-[min(92vw,360px)] rounded-2xl border border-white/20 bg-black/75 p-3 shadow-[0_12px_42px_rgba(0,0,0,0.55)] backdrop-blur-xl"
  data-collapsed="false"
>
  <div class="flex items-center justify-between gap-3">
    <p class="text-[10px] uppercase tracking-[0.3em] text-gold/90">SoundCloud Stream</p>
    <button
      id="global-mini-player-toggle"
      type="button"
      class="rounded-full border border-white/25 px-3 py-1 text-[10px] uppercase tracking-[0.26em] text-white/80 hover:border-gold/60 hover:text-gold"
      aria-controls="global-mini-player-panel"
      aria-expanded="true"
    >
      Minimize
    </button>
  </div>
  <div id="global-mini-player-panel" class="mt-3 overflow-hidden rounded-xl border border-white/15 bg-black/80">
    <iframe
      src={soundcloudEmbedUrl}
      title="Chip Lee SoundCloud mini player"
      class="h-[132px] w-full"
      allow="autoplay"
      loading="lazy"
    />
  </div>
</aside>

<script is:inline>
  (() => {
    const root = document.getElementById("global-mini-player");
    if (!root || root.dataset.bound === "true") return;
    root.dataset.bound = "true";

    const panel = document.getElementById("global-mini-player-panel");
    const toggle = document.getElementById("global-mini-player-toggle");
    const storageKey = "the-performa-mini-player-collapsed";

    if (!panel || !toggle) return;

    const setCollapsed = (collapsed) => {
      root.dataset.collapsed = String(collapsed);
      panel.hidden = collapsed;
      toggle.textContent = collapsed ? "Open Player" : "Minimize";
      toggle.setAttribute("aria-expanded", String(!collapsed));
    };

    const saved = localStorage.getItem(storageKey) === "true";
    setCollapsed(saved);

    toggle.addEventListener("click", () => {
      const next = root.dataset.collapsed !== "true";
      setCollapsed(next);
      localStorage.setItem(storageKey, String(next));
    });
  })();
</script>
