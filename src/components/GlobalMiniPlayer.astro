---
import listen from "../../content/listen.json";

const soundcloudTracks = listen.filter((item) => item.platform.toLowerCase() === "soundcloud");
const fallbackTrack = {
  title: "Chip Lee on SoundCloud",
  embedUrl: "https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/chipleetheperforma"
};
const initialTrack = soundcloudTracks[0] ?? fallbackTrack;
---

<aside
  id="global-mini-player"
  transition:name="global-mini-player"
  transition:persist
  class="fixed bottom-4 right-4 z-[70] w-[min(92vw,360px)] rounded-2xl border border-white/20 bg-black/75 p-3 shadow-[0_12px_42px_rgba(0,0,0,0.55)] backdrop-blur-xl"
  data-collapsed="false"
  data-tracks={JSON.stringify(soundcloudTracks.length ? soundcloudTracks : [fallbackTrack])}
  data-index="0"
>
  <div class="flex items-center justify-between gap-3">
    <p class="text-[10px] uppercase tracking-[0.3em] text-gold/90">SoundCloud Stream</p>
    <div class="flex items-center gap-2">
      <button
        id="global-mini-player-prev"
        type="button"
        class="rounded-full border border-white/25 px-2 py-1 text-[10px] uppercase tracking-[0.2em] text-white/80 hover:border-gold/60 hover:text-gold"
        aria-label="Previous track"
      >&lt;</button>
      <button
        id="global-mini-player-next"
        type="button"
        class="rounded-full border border-white/25 px-2 py-1 text-[10px] uppercase tracking-[0.2em] text-white/80 hover:border-gold/60 hover:text-gold"
        aria-label="Next track"
      >&gt;</button>
      <button
        id="global-mini-player-toggle"
        type="button"
        class="rounded-full border border-white/25 px-3 py-1 text-[10px] uppercase tracking-[0.26em] text-white/80 hover:border-gold/60 hover:text-gold"
        aria-controls="global-mini-player-panel"
        aria-expanded="true"
      >
        Minimize
      </button>
    </div>
  </div>
  <p id="global-mini-player-track-title" class="mt-2 truncate text-[10px] uppercase tracking-[0.2em] text-white/65">{initialTrack.title}</p>
  <div id="global-mini-player-panel" class="mt-3 overflow-hidden rounded-xl border border-white/15 bg-black/80">
    <iframe
      id="global-mini-player-iframe"
      src={initialTrack.embedUrl}
      title="Chip Lee SoundCloud mini player"
      class="h-[132px] w-full"
      allow="autoplay"
      loading="lazy"
    />
  </div>
</aside>

<script is:inline>
  (() => {
    const root = document.getElementById("global-mini-player");
    if (!root || root.dataset.bound === "true") return;
    root.dataset.bound = "true";

    const panel = document.getElementById("global-mini-player-panel");
    const toggle = document.getElementById("global-mini-player-toggle");
    const prev = document.getElementById("global-mini-player-prev");
    const next = document.getElementById("global-mini-player-next");
    const iframe = document.getElementById("global-mini-player-iframe");
    const title = document.getElementById("global-mini-player-track-title");
    const storageKey = "the-performa-mini-player-collapsed";

    if (!panel || !toggle || !prev || !next || !iframe || !title) return;

    const tracks = (() => {
      try {
        const parsed = JSON.parse(root.dataset.tracks || "[]");
        return Array.isArray(parsed) ? parsed.filter((item) => item && item.embedUrl) : [];
      } catch {
        return [];
      }
    })();
    let index = Number(root.dataset.index || "0");

    const syncTrack = () => {
      if (!tracks.length) return;
      index = (index + tracks.length) % tracks.length;
      const current = tracks[index];
      root.dataset.index = String(index);
      iframe.setAttribute("src", current.embedUrl);
      title.textContent = current.title || "SoundCloud Track";
    };

    const setCollapsed = (collapsed) => {
      root.dataset.collapsed = String(collapsed);
      panel.hidden = collapsed;
      toggle.textContent = collapsed ? "Open Player" : "Minimize";
      toggle.setAttribute("aria-expanded", String(!collapsed));
    };

    const saved = localStorage.getItem(storageKey) === "true";
    setCollapsed(saved);
    syncTrack();

    const hasTrackCycle = tracks.length > 1;
    prev.disabled = !hasTrackCycle;
    next.disabled = !hasTrackCycle;
    if (!hasTrackCycle) {
      prev.classList.add("opacity-40", "cursor-not-allowed");
      next.classList.add("opacity-40", "cursor-not-allowed");
    }

    const playPrev = () => {
      if (!hasTrackCycle) return;
      index -= 1;
      syncTrack();
    };

    const playNext = () => {
      if (!hasTrackCycle) return;
      index += 1;
      syncTrack();
    };

    toggle.addEventListener("click", () => {
      const nextCollapsed = root.dataset.collapsed !== "true";
      setCollapsed(nextCollapsed);
      localStorage.setItem(storageKey, String(nextCollapsed));
    });

    prev.addEventListener("click", playPrev);
    next.addEventListener("click", playNext);
  })();
</script>
