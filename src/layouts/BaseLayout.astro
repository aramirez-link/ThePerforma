---
import "../styles/global.css";
import Nav from "../components/Nav.astro";
import Footer from "../components/Footer.astro";
import Seo from "../components/Seo.astro";
import { ViewTransitions } from "astro:transitions";

const {
  title = "The Performa",
  description = "Cinematic entertainer experience.",
  canonical = "",
  image = "/media/og-default.svg",
  schema = null
} = Astro.props;
---
<!doctype html>
<html lang="en">
  <head>
    <ViewTransitions />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400;6..96,700&family=Space+Grotesk:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <Seo title={title} description={description} canonical={canonical} image={image} />
    <meta name="theme-color" content="#07070a" />
    {schema && <script type="application/ld+json" set:html={JSON.stringify(schema)} />}
  </head>
  <body class="text-white" data-stage="false" data-stage-profile="club" data-stage-intensity="45">
    <Nav />
    <main>
      <slot />
    </main>
    <Footer />
    <script>
      const STAGE_KEY = "the-performa-stage-mode";
      const listeners = new Set();
      const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)");

      const defaults = {
        active: false,
        immersive: false,
        profile: "club",
        intensity: 45
      };

      const readStoredMode = () => {
        try {
          const raw = localStorage.getItem(STAGE_KEY);
          if (!raw) return defaults;
          const parsed = JSON.parse(raw);
          return { ...defaults, ...parsed };
        } catch {
          return defaults;
        }
      };

      const syncBody = (mode) => {
        document.body.dataset.stage = String(mode.active);
        document.body.dataset.stageProfile = mode.profile;
        document.body.dataset.stageIntensity = String(mode.intensity);
      };

      let stageMode = readStoredMode();
      if (prefersReduced.matches) stageMode.immersive = false;
      syncBody(stageMode);

      window.__stageMode = {
        get() {
          return stageMode;
        },
        set(patch) {
          stageMode = { ...stageMode, ...patch };
          if (prefersReduced.matches) stageMode.immersive = false;
          syncBody(stageMode);
          localStorage.setItem(STAGE_KEY, JSON.stringify(stageMode));
          listeners.forEach((cb) => cb(stageMode));
        },
        subscribe(cb) {
          listeners.add(cb);
          cb(stageMode);
          return () => listeners.delete(cb);
        }
      };

      if (!prefersReduced.matches) {
        const revealItems = document.querySelectorAll("[data-reveal]");
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.2 }
        );
        revealItems.forEach((item) => observer.observe(item));
      }
    </script>
  </body>
</html>
