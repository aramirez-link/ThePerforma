---
import BaseLayout from "../layouts/BaseLayout.astro";
import Section from "../components/Section.astro";
import Card from "../components/Card.astro";
import events from "../../content/events.json";

const schema = {
  "@context": "https://schema.org",
  "@type": "MusicEvent",
  name: "The Performa Live",
  performer: { "@type": "MusicGroup", name: "The Performa" }
};

const toUtcDate = (date: string) => `${date.replace(/-/g, "")}T200000Z`;
const nextUtcDate = (date: string) => {
  const d = new Date(`${date}T00:00:00Z`);
  d.setUTCDate(d.getUTCDate() + 1);
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  return `${yyyy}${mm}${dd}T020000Z`;
};

const eventCalendarLinks = (event: { date: string; city: string; venue: string }) => {
  const title = encodeURIComponent(`Chip Lee Live - ${event.city}`);
  const details = encodeURIComponent(`Chip Lee live appearance at ${event.venue}.`);
  const location = encodeURIComponent(`${event.venue}, ${event.city}`);
  const start = toUtcDate(event.date);
  const end = nextUtcDate(event.date);
  const google = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}&location=${location}`;
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//The Performa//Live Calendar//EN
BEGIN:VEVENT
UID:${event.date}-${event.city.replace(/\s+/g, "-").toLowerCase()}@theperforma.com
DTSTAMP:${start}
DTSTART:${start}
DTEND:${end}
SUMMARY:Chip Lee Live - ${event.city}
DESCRIPTION:Chip Lee live appearance at ${event.venue}.
LOCATION:${event.venue}\\, ${event.city}
END:VEVENT
END:VCALENDAR`;
  return {
    google,
    ics: `data:text/calendar;charset=utf-8,${encodeURIComponent(ics)}`
  };
};
---
<BaseLayout title="Live Dates | The Performa" description="Upcoming shows and festival appearances." schema={schema}>
  <section class="mx-auto max-w-6xl px-4 pt-8 sm:px-6">
    <div class="relative overflow-hidden rounded-[2rem] border border-white/15">
      <img src="/assets/img/096NewChip_4K.jpg" alt="" aria-hidden="true" class="h-[40vh] w-full object-cover opacity-40" />
      <div class="absolute inset-0 bg-[linear-gradient(180deg,rgba(7,7,11,0.28),rgba(7,7,11,0.9))]"></div>
      <div class="absolute inset-0 flex items-end p-5 md:p-8">
        <div>
          <p class="text-xs uppercase tracking-[0.34em] text-gold/90">Live Routing</p>
          <h1 class="mt-3 font-display text-4xl md:text-5xl">Chip Lee - Global Stage Calendar</h1>
          <p class="mt-3 max-w-2xl text-sm text-white/75 md:text-base">Confirmed appearances, city activations, and next booking windows - all in one performance timeline.</p>
        </div>
      </div>
    </div>
  </section>
  <Section eyebrow="Live" title="Upcoming Events" subtitle="Worldwide availability - confirmed dates and announcements below.">
    <div class="grid gap-6 md:grid-cols-3">
      {events.map((event) => {
        const links = eventCalendarLinks(event);
        return (
          <Card title={`${event.city}`} subtitle={`${event.venue} - ${event.date}`} highlight={event.status}>
            <div class="flex flex-wrap items-center gap-3">
              <a href={event.ticketUrl} class="text-xs uppercase tracking-[0.3em] text-ember">Tickets</a>
              <a href={links.google} target="_blank" rel="noreferrer" class="text-[10px] uppercase tracking-[0.24em] text-white/70 hover:text-gold">Google</a>
              <a href={links.ics} download={`chip-lee-${event.city.replace(/[\s,]+/g, "-").toLowerCase()}.ics`} class="text-[10px] uppercase tracking-[0.24em] text-white/70 hover:text-gold">.ics</a>
            </div>
          </Card>
        );
      })}
    </div>
    <div class="mt-10 rounded-3xl border border-white/15 bg-black/50 p-6 text-sm text-white/70 shadow-[0_0_70px_rgba(242,84,45,0.1)]">
      Want updates? <a href="/" class="text-ember">Get notified</a>
    </div>
  </Section>
</BaseLayout>

